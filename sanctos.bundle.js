(()=>{var Pt="mainnet-beta";(()=>{let d=typeof window<"u"?window:globalThis;d.__SANCTOS_KILLED__=!1,d.sanctosKillSwitch=function(){console.warn("[SanctOS\u2620\uFE0F] Kill-switch ACTIVATED \u2014 wiping identity and disabling all crypto"),d.__SANCTOS_KILLED__=!0;try{localStorage.clear()}catch{}try{sessionStorage.clear()}catch{}d.sanctos=d.sanctos||{};let M=(...W)=>{throw new Error("SanctOS identity revoked \u2014 operation blocked.")};d.sanctos.getDeviceKeypair=M,d.sanctos.deriveSharedKey=M,d.sanctos.encryptMessage=M,d.sanctos.decryptMessage=M,d.sanctos.postMessage=M,d.sanctos.postSanctosMsg=M,d.sanctos._buildEncryptedTx=M,d.sanctos.fetchMessages=M,d.sanctos.publishDevicePubkeyIfNeeded=M,console.warn("[SanctOS\u2620\uFE0F] All SanctOS operations BLOCKED.")},d.sanctos.revokeIdentity=d.sanctosKillSwitch})();(()=>{let d=typeof window<"u"?window:globalThis;try{if(!d.nacl)try{d.nacl=require?.("tweetnacl")}catch{}d.nacl||console.warn("[SanctOS] \u26A0\uFE0F tweetnacl not found; load nacl-fast.min.js or bundle it")}catch{}})();var Te="MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr";(()=>{let d=typeof window<"u"?window:globalThis;d.nacl||(d.nacl=typeof nacl<"u"?nacl:d.nacl,d.nacl&&console.log("[SanctOS] \u{1F517} tweetnacl bound to globalThis"))})();typeof atob>"u"&&(globalThis.atob=d=>Buffer.from(d,"base64").toString("binary"),globalThis.btoa=d=>Buffer.from(d,"binary").toString("base64"),console.log("[SanctOS] \u{1F9E9} Base64 polyfill attached (Node/Electron)"));function nn(d){if(!d)return"";let M=d.replace(/-/g,"+").replace(/_/g,"/");for(;M.length%4!==0;)M+="=";return globalThis.atob(M)}function ue(d){return btoa(String.fromCharCode(...d)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}(()=>{let d=typeof window<"u"?window:globalThis;d.sanctos=d.sanctos||{},d.sanctos.encodeB64Url=ue,d.sanctos.atobSafe=nn,console.log("[SanctOS] \u{1F9E9} Base64URL helpers globally attached")})();(()=>{let d=typeof window<"u"?window:globalThis;d.__sanctosRepair=d.__sanctosRepair||{},Object.defineProperties(d.__sanctosRepair,{autoRepairPeerKey:{configurable:!0,enumerable:!0,writable:!0,value:null},repairPeerKey:{configurable:!0,enumerable:!0,writable:!0,value:null}}),console.log("[SanctOS] \u{1F9E9} Early global repair slots initialized")})();(()=>{let d=typeof window<"u"?window:globalThis;if(d.sanctos||(d.sanctos={},console.log("[SanctOS] \u{1F310} Created global window.sanctos early")),typeof d.Buffer>"u")try{d.Buffer={from:(M,W)=>{if(typeof M=="string"){if(W==="hex"){let ee=new Uint8Array(M.length/2);for(let q=0;q<ee.length;q++)ee[q]=parseInt(M.substr(q*2,2),16);return ee}return new TextEncoder().encode(M)}return ArrayBuffer.isView(M)||M instanceof ArrayBuffer?new Uint8Array(M):Array.isArray(M)?new Uint8Array(M):new Uint8Array([])},concat:M=>{let W=M.reduce((ne,ie)=>ne+ie.length,0),ee=new Uint8Array(W),q=0;for(let ne of M)ee.set(ne,q),q+=ne.length;return ee}},console.log("[SanctOS] \u{1F9EC} Injected minimal Buffer polyfill")}catch{}d.__SANCTOS_READY__=!0})();async function Fn(){return new Promise((d,M)=>{let W=Date.now(),ee=()=>{let q=window.anchor,ne=window.solanaWeb3||window.web3;if(q&&ne)return d({anchor:q,solanaWeb3:ne});if(Date.now()-W>8e3)return M("Timeout waiting for globals");setTimeout(ee,100)};ee()})}(async()=>{let d,M;try{({anchor:d,solanaWeb3:M}=await Fn())}catch{console.warn("[SanctOS] \u26A0\uFE0F Timeout waiting for globals; continuing best-effort");let e=typeof window<"u"?window:globalThis;d=e.anchor||e.GO||e.wd||{},M=e.solanaWeb3||e.solana||e.web3||{}}try{let e=typeof window<"u"?window:globalThis;if(!d||Object.keys(d).length===0){let t=[e.GO,e.wd,e.exports,e];for(let n of t)if(!(!n||typeof n!="object")){if(n.Program||n.AnchorProvider){d=n,console.log("[SanctOS] \u{1F9E9} Reconstructed anchor from exports");break}if(n?.default&&(n.default.Program||n.default.AnchorProvider)){d=n.default,console.log("[SanctOS] \u{1F9E9} Reconstructed anchor from default export");break}}}}catch{}let W=M?.PublicKey,ee=M?.SystemProgram||M?.web3?.SystemProgram,q=M?.Connection||M?.web3?.Connection,ne=M?.Transaction,ie=M?.TransactionInstruction,z=M?.Keypair,H="EBEQdAwgXmyLrj5npwmX63cEZwzrSKgEHy297Nfxrjhw",L=W?new W(H):H,F=new M.PublicKey(Te),x={enc:e=>btoa(String.fromCharCode(...e)),dec:e=>new Uint8Array(nn(e).split("").map(t=>t.charCodeAt(0)))};(()=>{let e=typeof window<"u"?window:globalThis;e.b64u?.dec||(e.b64u=x),typeof e.encodeB64Url!="function"&&(e.encodeB64Url=ue)})();let ae=null;(function(){let t=typeof window<"u"?window:globalThis;if(t.bs58){ae=t.bs58,console.log("[SanctOS] \u2705 Using existing global bs58");return}let n=["https://unpkg.com/bs58@6.0.0/dist/bs58.umd.js","https://cdn.jsdelivr.net/npm/bs58@6.0.0/dist/bs58.umd.js","https://esm.run/bs58@6.0.0"],a=0,o=()=>{if(a>=n.length){console.warn("[SanctOS] \u26A0\uFE0F All bs58 CDN sources failed, using fallback"),ae={decode:r=>new TextEncoder().encode(r),encode:r=>new TextDecoder().decode(r)},t.bs58=ae;return}let c=n[a++],l=document.createElement("script");l.src=c,l.async=!0,l.onload=()=>{ae=t.bs58||t.default||null,ae&&typeof ae.decode=="function"?(t.bs58=ae,console.log(`[SanctOS] \u2705 bs58 loaded via CDN: ${c}`)):(console.warn(`[SanctOS] \u26A0\uFE0F Loaded ${c} but bs58 not found \u2014 trying next`),o())},l.onerror=()=>{console.warn(`[SanctOS] \u26A0\uFE0F Failed to load bs58 from ${c}`),o()},document.head.appendChild(l)};o()})();let te={enc:e=>new TextEncoder().encode(String(e??"")),dec:e=>{try{if(e==null)return"";if(typeof e=="string")return e;let t=null;if(e instanceof Uint8Array?t=e:ArrayBuffer.isView(e)?t=new Uint8Array(e.buffer):e instanceof ArrayBuffer?t=new Uint8Array(e):Array.isArray(e)?t=Uint8Array.from(e):typeof e=="object"&&(Array.isArray(e.data)?t=new Uint8Array(e.data):e.data instanceof ArrayBuffer?t=new Uint8Array(e.data):e.type==="Buffer"&&Array.isArray(e.data)&&(t=new Uint8Array(e.data))),!t)return String(e??"");try{return new TextDecoder().decode(t)}catch{return String.fromCharCode(...t)}}catch{return String(e??"")}}};async function Qe(e){let t=await crypto.subtle.digest("SHA-256",e);return new Uint8Array(t)}function ye(e){let a=Z(typeof window<"u"?window:globalThis).PublicKey;if(!e)throw new Error("[SanctOS] Invalid PublicKey input");return typeof e.toBase58=="function"&&typeof e.toBuffer=="function"?e:typeof e=="string"?new a(e):typeof e.toBase58=="function"?new a(e.toBase58()):e.publicKey&&typeof e.publicKey.toBase58=="function"?new a(e.publicKey.toBase58()):new a(String(e))}function we(e,t){let n=Math.min(e.length,t.length);for(let a=0;a<n;a++)if(e[a]!==t[a])return e[a]-t[a];return e.length-t.length}function et(e,t){let n=ye(e),a=ye(t);return we(n.toBuffer(),a.toBuffer())<=0?[n,a]:[a,n]}function xe(e,t){let o=Z(typeof window<"u"?window:globalThis).PublicKey,[c,l]=et(e,t);return o.findProgramAddressSync([Buffer.from("thread"),c.toBuffer(),l.toBuffer()],L)}function We(e,t){let o=Z(typeof window<"u"?window:globalThis).PublicKey,c=ye(e),l=ye(t);return o.findProgramAddressSync([Buffer.from("thread"),c.toBuffer(),l.toBuffer()],L)}function Tt(e,t){return{sorted:xe(e,t)[0],unsorted:We(e,t)[0]}}function he(e,t){return xe(e,t)}async function Ot(e,t,n){let[a,o]=et(t,n),c=[{pda:We(t,n)[0],kind:"unsorted_me_peer"},{pda:We(n,t)[0],kind:"unsorted_peer_me"},{pda:xe(t,n)[0],kind:"sorted"}];for(let r of c)try{let s=await e.getAccountInfo(r.pda);if(s&&s.data&&s.data.length>0)return console.log(`[SanctOS] \u{1F9E0} Resolved thread PDA: ${r.pda.toBase58()} (mode: ${r.kind}, exists: true)`),{pda:r.pda,exists:!0,kind:r.kind,lower:a,higher:o}}catch(s){console.warn("[SanctOS] \u26A0\uFE0F PDA probe failed:",r.kind,s)}let[l]=xe(t,n);return console.log(`[SanctOS] \u{1F9E0} No existing thread found. Using canonical sorted PDA: ${l.toBase58()}`),{pda:l,exists:!1,kind:"sorted",lower:a,higher:o}}let me=null,pe=typeof window<"u"?window:globalThis;pe.__sanctosSigCache=pe.__sanctosSigCache||new Map,pe.__sanctosHeadSigCache=pe.__sanctosHeadSigCache||new Map,pe.__sanctosFetchPollState=pe.__sanctosFetchPollState||new Map;let fe=pe.__sanctosSigCache,Re=pe.__sanctosHeadSigCache,Ee=pe.__sanctosFetchPollState;async function Ne(e){try{if(!e||!e.wallet||!e.wallet.publicKey)return;let t=typeof window<"u"?window:globalThis,n=e.wallet.publicKey,a=n.toBase58(),o=E(a);if((()=>{try{return!!localStorage.getItem(o)}catch{return!1}})())return;let l=!1;try{l=await Se(e,n)}catch(r){console.warn("[SanctOS\u{1F511}] hasOnchainDeviceKey check failed (non-fatal):",r),l=!1}if(l){console.log("[SanctOS\u{1F511}] Existing on-chain device key detected but no local key. Deferring to UI gate (IMPORT)."),t.__sanctosNeedsDeviceImport=a;return}console.log("[SanctOS\u{1F511}] No local device key yet. Deferring to UI gate (CREATE/IMPORT)."),t.__sanctosNeedsIdentitySetup=a;return}catch(t){console.warn("[SanctOS] \u26A0\uFE0F ensureDeviceIdentityOnConnect failed:",t)}}let Ge=(typeof window<"u"?window:globalThis).SANCTOS_RPC||"https://sanctos-rpc-node.sanctos.workers.dev";async function V(e=!1){let t=window,n=d?.AnchorProvider||d?.Provider,a=Ge;(!me||e)&&(console.log(`[SanctOS] \u{1F517} Using locked SanctOS RPC: ${a}`),me=new M.Connection(a,{commitment:"confirmed",disableRetryOnRateLimit:!1,wsEndpoint:""}),me._disableWebsocket=!0,me._startWebsocket=()=>{},me._handleWsMessage=()=>{},console.log("[SanctOS] \u{1F310} RPC mode: HTTPS-only (WebSocket disabled)"));let o=me;if(t?.solana?.isPhantom){t.solana.publicKey||await t.solana.connect();let r={publicKey:new M.PublicKey(t.solana.publicKey.toString()),signTransaction:async i=>(i.feePayer||(i.feePayer=r.publicKey),await t.solana.signTransaction(i)),signAllTransactions:async i=>await t.solana.signAllTransactions(i)};if(typeof n=="function"){let i=new n(o,r,{preflightCommitment:"confirmed",commitment:"confirmed"});return await Ne(i),i}let s={connection:o,wallet:r};return await Ne(s),s}let c=M.Keypair.generate(),l={publicKey:c.publicKey,signTransaction:async r=>(r.partialSign(c),r),signAllTransactions:async r=>{for(let s of r)s.partialSign(c);return r}};return typeof n=="function"?new n(o,l,{preflightCommitment:"confirmed",commitment:"confirmed"}):{connection:o,wallet:l}}function h(e){return{idl:{version:"0.1.0",name:"sanctos_messenger",instructions:[{name:"init_thread",accounts:[{name:"user",isMut:!0,isSigner:!0},{name:"peer",isMut:!1,isSigner:!1},{name:"thread",isMut:!0,isSigner:!1},{name:"systemProgram",isMut:!1,isSigner:!1}],args:[]},{name:"post_pointer",accounts:[{name:"user",isMut:!0,isSigner:!0},{name:"peer",isMut:!1,isSigner:!1},{name:"thread",isMut:!0,isSigner:!1}],args:[{name:"pointer32",type:{array:["u8",32]}}]}]},account:{}}}async function A(e){return(await Qe(te.enc("global:"+e))).slice(0,8)}function I(){let e=typeof window<"u"?window:globalThis;return String(e.SANCTOS_CLUSTER_STORAGE||e.SANCTOS_CLUSTER||"mainnet").trim()}function E(e){return`sanctos:x25519:${I()}:${e}`}function B(e){return`sanctos:delegate:${I()}:${e}`}(()=>{let e=typeof window<"u"?window:globalThis;e.deviceStoreKey=t=>E(String(t||""))})();function R(e,t=!1){let n=typeof window<"u"?window:globalThis,a=n.nacl||(n.nacl=globalThis.nacl||null);if(!a||!a.box)throw new Error("[SanctOS] \u274C tweetnacl not loaded \u2014 include nacl-fast.min.js first");let o=e?.toBase58?e.toBase58():String(e||"");if(!o)throw new Error("[SanctOS] Invalid wallet identity (missing public key)");let c=E(o),l=localStorage.getItem(c);if(l)try{let i=JSON.parse(l);return{publicKey:x.dec(i.pub),secretKey:x.dec(i.sec)}}catch(i){console.warn("[SanctOS] \u26A0\uFE0F Corrupt device keypair; removing:",i),localStorage.removeItem(c)}if(!t)throw new Error(`[SanctOS] No device key found for ${o}. Please create or import identity.`);if(!(n.SANCTOS_ALLOW_AUTO_CREATE_IDENTITY===!0))throw new Error("[SanctOS] Auto-create disabled. Please create identity through the UI.");let s=a.box.keyPair();return localStorage.setItem(c,JSON.stringify({pub:x.enc(s.publicKey),sec:x.enc(s.secretKey)})),s}function X(e){try{let t=e?.toBase58?e.toBase58():String(e);return!!localStorage.getItem(E(t))}catch{return!1}}(()=>{let e=typeof window<"u"?window:globalThis;e.sanctos=e.sanctos||{},e.sanctos.buildDelegateInitForPublish||(e.sanctos.buildDelegateInitForPublish=async function(t,n){return{ixs:[],signers:[]}})})(),(()=>{let e=typeof window<"u"?window:globalThis;e.sanctos=e.sanctos||{},e.sanctos.getIdentityStatusAsync=async function(t){let n=t||e.wallet?.address||e.solana?.publicKey?.toBase58?.();if(!n)return{needsSetup:!0,needsImport:!1,needsPublish:!1,ready:!1};if(!!!localStorage.getItem(E(n)))return{needsSetup:!0,needsImport:!1,needsPublish:!1,ready:!1};try{let o=await V(),c=o.wallet.publicKey;return await e.sanctos.hasOnchainDeviceKey(o,c,60)?{needsSetup:!1,needsImport:!1,needsPublish:!1,ready:!0}:{needsSetup:!1,needsImport:!1,needsPublish:!0,ready:!1}}catch{return{needsSetup:!1,needsImport:!1,needsPublish:!0,ready:!1}}}})();function J(e){let t=String(e||"").trim();return t&&(t.startsWith("SANCTOS_ID:")?t.slice(11).trim():t)}async function oe(){let e=await Gt(),n=(await V()).wallet.publicKey,a=n.toBase58(),o=null;try{o=typeof globalThis.getOrCreateDelegateKeypair=="function"?globalThis.getOrCreateDelegateKeypair(n):null}catch{}if(!o){let l=Z(typeof window<"u"?window:globalThis),r=localStorage.getItem(B(a));if(r){let s=JSON.parse(r),i=s?.secret||s?.secretKey,u=i instanceof Uint8Array?i:Uint8Array.from(i);o=l.Keypair.fromSecretKey(u)}else o=l.Keypair.generate(),localStorage.setItem(B(a),JSON.stringify({owner:a,pub:o.publicKey.toBase58(),secret:Array.from(o.secretKey),createdAt:Date.now()}))}return{kind:"sanctos-identity-bundle",v:1,me:e.me,devPub:e.devPub,devSec:e.devSec,delPub:o.publicKey.toBase58(),delSec:ue(o.secretKey),createdAt:Date.now()}}function Oe(e){let t=String(e??""),n=new Set;n.add(t),n.add(t.trim());try{n.add(t.normalize("NFKC"))}catch{}try{n.add(t.trim().normalize("NFKC"))}catch{}return Array.from(n).filter(a=>typeof a=="string"&&a.length>=4)}async function Kt(e){e=String(e??"");let t=Oe(e);if(!t.length)throw new Error("Passphrase must be at least 4 characters");e=t[t.length-1];let n=await oe(),a=te.enc(JSON.stringify(n)),o=crypto.getRandomValues(new Uint8Array(16)),c=crypto.getRandomValues(new Uint8Array(12)),l=await nt(e,o),r=await crypto.subtle.encrypt({name:"AES-GCM",iv:c},l,a),s=new Uint8Array(r),i={v:2,kind:"sanctos-identity-bundle-export",algo:"PBKDF2-AES-GCM",me:n.me,salt:ue(o),iv:ue(c),ciphertext:ue(s)};return`SANCTOS_ID:${ue(te.enc(JSON.stringify(i)))}`}async function tt(e,t){let n=J(e);if(!n)throw new Error("Empty identity bundle");t=String(t??"");let a=Oe(t);if(!a.length)throw new Error("Passphrase must be at least 4 characters");let o;try{o=JSON.parse(te.dec(x.dec(n)))}catch{return await wt(n,t)}if(o?.kind==="sanctos-device-key-export")return await wt(n,t);if(o?.kind!=="sanctos-identity-bundle-export")throw new Error("Not a SanctOS identity bundle export");let c=x.dec(o.salt),l=x.dec(o.iv),r=x.dec(o.ciphertext),s=null,i=Number(o?.it),u=Array.from(new Set([i,1e5,21e4].filter(w=>Number.isFinite(w)).map(w=>Math.floor(Number(w))).filter(w=>w>=1e4&&w<=2e6)));for(let w of a){for(let _ of u)try{let m=await nt(w,c,_);s=await crypto.subtle.decrypt({name:"AES-GCM",iv:l},m,r);break}catch{}if(s)break}if(!s)throw new Error("Failed to decrypt identity bundle \u2014 wrong passphrase?");let g=JSON.parse(te.dec(new Uint8Array(s)));if(g?.kind!=="sanctos-identity-bundle"||!g?.me||!g?.devPub||!g?.devSec||!g?.delPub||!g?.delSec)throw new Error("Invalid identity bundle payload");let p=g.me;localStorage.setItem(E(p),JSON.stringify({pub:g.devPub,sec:g.devSec}));let y=x.dec(g.delSec),f=M.Keypair.fromSecretKey(y);return localStorage.setItem(B(p),JSON.stringify({owner:p,pub:f.publicKey.toBase58(),secret:Array.from(f.secretKey),importedAt:Date.now()})),(typeof window<"u"?window:globalThis).__sanctosDelegateKeypair=f,console.log("[SanctOS\u{1F511}] Identity bundle imported for",p),await zt(p),{me:p}}(()=>{let e=typeof window<"u"?window:globalThis;e.sanctos=e.sanctos||{},e.sanctos.exportIdentityBundleString=Kt,e.sanctos.importIdentityBundleFromExport=tt})(),(()=>{let e=typeof window<"u"?window:globalThis;e.sanctos=e.sanctos||{};let t=new TextEncoder;async function n(l){return new Uint8Array(await crypto.subtle.digest("SHA-256",l))}async function a(l){return(await n(t.encode(`global:${l}`))).slice(0,8)}function o(l){let r=new ArrayBuffer(8);return new DataView(r).setBigInt64(0,BigInt(l),!0),new Uint8Array(r)}function c(l,r){if(e.__sanctosDelegateKeypair?.secretKey instanceof Uint8Array)return e.__sanctosDelegateKeypair;let s=r.toBase58(),i=B(s),u=localStorage.getItem(i);if(u){let p=JSON.parse(u),y=p?.secret||p?.secretKey;if(!y)throw new Error("delegate record found but missing secret/secretKey");let f=y instanceof Uint8Array?y:Uint8Array.from(y),w=l.Keypair.fromSecretKey(f);return e.__sanctosDelegateKeypair=w,w}let g=l.Keypair.generate();return localStorage.setItem(i,JSON.stringify({owner:s,pub:g.publicKey.toBase58(),secret:Array.from(g.secretKey),createdAt:Date.now()})),e.__sanctosDelegateKeypair=g,g}e.sanctos.buildDelegateInitForPublish=async function(r,s){let i=Z(e),{PublicKey:u,TransactionInstruction:g,SystemProgram:p}=i;if(!r?.connection)throw new Error("buildDelegateInitForPublish: provider.connection missing");let y=new u("EBEQdAwgXmyLrj5npwmX63cEZwzrSKgEHy297Nfxrjhw"),f=s instanceof u?s:new u(s?.toBase58?.()||String(s)),_=c(i,f).publicKey,[m]=u.findProgramAddressSync([Buffer.from("delegate"),f.toBuffer(),_.toBuffer()],y);if((await r.connection.getAccountInfo(m,"confirmed"))?.data?.length)return{ixs:[],signers:[],owner:f.toBase58(),delegate:_.toBase58(),authPda:m.toBase58(),created:!1};let b=Math.floor(Date.now()/1e3)+60*60*24*30,K=await a("set_delegate"),T=new Uint8Array(16);return T.set(K,0),T.set(o(b),8),{ixs:[new g({programId:y,keys:[{pubkey:f,isSigner:!0,isWritable:!0},{pubkey:_,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p.programId,isSigner:!1,isWritable:!1}],data:T})],signers:[],owner:f.toBase58(),delegate:_.toBase58(),authPda:m.toBase58(),created:!0,expires:b}}})();async function Se(e,t,n=60){try{let c=function(s){try{if(!s)return"";if(typeof s=="string"){if(s.startsWith("SANCTOS_"))return s;let i=o.bs58||typeof o.bs58mod<"u"&&o.bs58mod;if(i?.decode&&/^[1-9A-HJ-NP-Za-km-z]+$/.test(s)){let u=i.decode(s);return new TextDecoder().decode(u)}return""}return s instanceof Uint8Array?new TextDecoder().decode(s):Array.isArray(s)?new TextDecoder().decode(new Uint8Array(s)):s?.data&&Array.isArray(s.data)?new TextDecoder().decode(new Uint8Array(s.data)):""}catch{return""}},a=e&&e.connection;if(!a||!t)return!1;let o=typeof window<"u"?window:globalThis,l=t.toBase58(),r=await a.getSignaturesForAddress(t,{limit:n});for(let s of r){let i=await a.getTransaction(s.signature,{commitment:"confirmed",maxSupportedTransactionVersion:0});if(!i)continue;let u=i.transaction.message.staticAccountKeys||i.transaction.message.accountKeys||[],g=i.transaction.message.instructions||[],p=(i.meta?.innerInstructions||[]).flatMap(f=>f.instructions||[]),y=g.concat(p);for(let f of y){let w="";try{if(f.programId&&f.programId.toBase58)w=f.programId.toBase58();else if(typeof f.programIdIndex=="number"){let b=u[f.programIdIndex];w=b&&b.toBase58?b.toBase58():""}}catch{w=""}if(w!==Te)continue;let _=c(f.data);if(!_||!_.startsWith("SANCTOS_PUBKEY:"))continue;let m=_.split(":");if(m.length<3)continue;if(String(m[1]||"")===l)return console.log("[SanctOS\u{1F50D}] Found existing SANCTOS_PUBKEY memo for wallet:",l),!0}}}catch(a){console.warn("[SanctOS] \u26A0\uFE0F hasOnchainDeviceKey failed:",a)}return!1}function Ue(e,t){let n=e.slice(0,32);return globalThis.nacl.box.before(t,n)}function Dt(e,t){let n=globalThis.nacl.randomBytes(24),a=new TextEncoder().encode(t),o=globalThis.nacl.secretbox(a,n,e);return{nonce:n,cipher:o}}function dt(e,t,n){try{let a=globalThis.nacl.secretbox.open(n,t,e);return a?new TextDecoder().decode(a):(console.warn("[SanctOS\u{1F512}] Decrypt failed (secretbox.open returned null)"),null)}catch(a){return console.error("[SanctOS] \u274C decryptMessage exception:",a),null}}globalThis.__sanctosDecryptTest=async(e,t,n,a)=>{try{let o=await e.connection.getTransaction(a,{maxSupportedTransactionVersion:0});if(!o)return console.warn("[SanctOS\u{1F50D}] Tx not found:",a);let c=o.transaction.message.staticAccountKeys||o.transaction.message.accountKeys||[],r=[...o.transaction.message.instructions||[],...o.meta?.innerInstructions?.flatMap(m=>m.instructions)||[]].find(m=>{try{return(m.programId?.toBase58?.()??c[m.programIdIndex]?.toBase58?.()??"")===F.toBase58?.()}catch{return!1}});if(!r)return console.warn("[SanctOS\u{1F50D}] No memo found in tx");let s=(()=>{let m=typeof window<"u"?window:globalThis,S=r.data;try{if(!S)return"";if(typeof S=="string"){if(S.startsWith("SANCTOS_"))return S;let b=m.bs58||typeof m.bs58mod<"u"&&m.bs58mod;if(b?.decode){let K=b.decode(S);return new TextDecoder().decode(K)}return S}return S instanceof Uint8Array?new TextDecoder().decode(S):Array.isArray(S)?new TextDecoder().decode(new Uint8Array(S)):S?.data&&Array.isArray(S.data)?new TextDecoder().decode(new Uint8Array(S.data)):""}catch{return""}})();if(!s.startsWith("SANCTOS_MSG:")){console.warn("[SanctOS\u{1F50D}] Memo isn\u2019t a SANCTOS_MSG:",s);return}let i=s.split(":").pop(),u=x.dec(i),g=u.slice(0,24),p=u.slice(24),y=R(t),f=await le(e,t,n);if(!f)return console.warn("[SanctOS\u{1F50D}] Peer device pubkey not found");let w=Ue(y.secretKey,f),_=dt(w,g,p);return console.log("[SanctOS\u{1F50D}] Decrypted output:",_),_??null}catch(o){return console.error("[SanctOS\u{1F50D}] self-test failed:",o),null}},(()=>{let e=typeof window<"u"?window:globalThis;e.sanctos=e.sanctos||{},e.sanctos.decryptTxTest=globalThis.__sanctosDecryptTest})(),(()=>{let e=typeof window<"u"?window:globalThis;e.sanctos=e.sanctos||{},e.sanctos.ensureLocalDeviceIdentity=async function(t,n){let o=(n||await V())?.wallet?.publicKey;if(!o)throw new Error("[SanctOS] No wallet publicKey on provider");let c=o.toBase58(),l=E(c);if(localStorage.getItem(l))return{me:c,created:!1};if(R(o,!0),!localStorage.getItem(l))throw new Error("[SanctOS] Failed to create local device key");return{me:c,created:!0}}})(),(()=>{let e=typeof window<"u"?window:globalThis;e.sanctos=e.sanctos||{},e.sanctos.hasOnchainDeviceKey=Se})(),(()=>{let e=typeof window<"u"?window:globalThis;e.SANCTOS_TREASURY="FhUFtN9MngoRj7YW1eYw57TxsYsTJ5xyMwMmdifxmwBi",e.SANCTOS_DELEGATE_TREASURY||(e.SANCTOS_DELEGATE_TREASURY=e.SANCTOS_TREASURY),Number.isFinite(e.SANCTOS_ACCOUNT_CREATION_FEE_LAMPORTS)||(e.SANCTOS_ACCOUNT_CREATION_FEE_LAMPORTS=1e5)})(),(()=>{let e=typeof window<"u"?window:globalThis;if(e.__SANCTOS_ACCTFEE_INSTALLED)return;e.__SANCTOS_ACCTFEE_INSTALLED=!0;function t(){let r=e.SANCTOS_ACCOUNT_CREATION_FEE_LAMPORTS??e.SANCTOS_ACCOUNT_FEE_LAMPORTS??0;if(typeof r=="bigint")return r>0n?r:0n;let s=Number(r);if(Number.isFinite(s))return BigInt(Math.max(0,Math.floor(s)));let i=Number(e.SANCTOS_ACCOUNT_CREATION_FEE_SOL??e.SANCTOS_ACCOUNT_FEE_SOL);return Number.isFinite(i)?BigInt(Math.max(0,Math.floor(i*1e9))):0n}function n(){return String(e.SANCTOS_DELEGATE_TREASURY||e.SANCTOS_TREASURY||"").trim()}function a(r){let s=new Uint8Array(4);return new DataView(s.buffer).setUint32(0,r>>>0,!0),s}function o(r){let s=BigInt(r);if(s<0n)throw new Error("lamports must be >= 0");let i=new Uint8Array(8);for(let u=0;u<8;u++)i[u]=Number(s&255n),s>>=8n;if(s!==0n)throw new Error("lamports exceeds u64");return i}function c(r,s){let i=new Uint8Array(r.length+s.length);return i.set(r,0),i.set(s,r.length),i}function l(r,s){if(!s)throw new Error("pubkey missing");return s instanceof r.PublicKey?s:typeof s=="string"?new r.PublicKey(s):typeof s.toBase58=="function"?new r.PublicKey(s.toBase58()):s.publicKey&&typeof s.publicKey.toBase58=="function"?new r.PublicKey(s.publicKey.toBase58()):new r.PublicKey(String(s))}e.__sanctosMaybeAddAccountFeeIx=function(s,i,u){try{if(!s?.PublicKey||!s?.SystemProgram||!s?.TransactionInstruction||!i?.add||i&&(i.__sanctosDelegated===!0||i.__sanctosSkipAccountFee===!0)||i.__sanctosAcctFeeAdded)return;i.__sanctosAcctFeeAdded=!0;try{let v=l(s,u),C=i?.feePayer?.toBase58?.()||"",k=v?.toBase58?.()||"";if(C&&k&&C!==k)return}catch{}let g=l(s,u),p=g.toBase58(),f=`sanctos:acctfee:paid:${I()}:${p}`,w=`sanctos:acctFeePaid:${p}`,_=`sanctos:acctfee:paid:${p}`;if(localStorage.getItem(f)==="1"||localStorage.getItem(w)==="1"||localStorage.getItem(_)==="1")return;let m=t();if(m<=0n)return;let S=n();if(!S)throw new Error("treasury missing");let b=new s.PublicKey(S),K=c(a(2),o(m)),T=new s.TransactionInstruction({programId:s.SystemProgram.programId,keys:[{pubkey:g,isSigner:!0,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0}],data:K});i.add(T),i.__sanctosAcctFeePaidKey=f}catch(g){console.warn("[SanctOS] Account-creation fee skipped (non-fatal):",g)}}})();let Fe=globalThis.__sanctosMemoInflight||(globalThis.__sanctosMemoInflight=new Set);function It(e){let t=e.solanaWeb3||e.web3||e.anchor&&e.anchor.web3;if(!t?.PublicKey||!t?.Transaction||!t?.TransactionInstruction)throw new Error("[SanctOS] solanaWeb3 missing/incomplete");return t}function an(){let e=typeof window<"u"?window:globalThis;return String(e.SANCTOS_CLUSTER_STORAGE||e.SANCTOS_CLUSTER||"mainnet").trim()}function Bt(e){return`sanctos:acctfee:paid:${an()}:${e}`}async function be(e,t,n){let a=typeof window<"u"?window:globalThis;try{let o=It(a),{PublicKey:c,Transaction:l,TransactionInstruction:r}=o;if(!e?.connection)throw new Error("[SanctOS] provider.connection missing");let s=e.wallet?.publicKey||e.wallet?.adapter?.publicKey||a.solana?.publicKey||null;if(!s&&a.solana?.isPhantom&&(console.warn("[SanctOS] Phantom reconnect for device memo\u2026"),await a.solana.connect(),s=a.solana.publicKey),!s)throw new Error("[SanctOS] Wallet not connected");let i=t?new c(t.toString()):new c(s.toString()),u=i.toBase58(),g=`sanctos:pubkey:announced:${u}`,p=g,y=Bt(u);if(localStorage.getItem(g)==="1"){console.log("[SanctOS] \u{1F9E0} Device pubkey already announced (localStorage):",g);return}try{let C=typeof a.sanctos?.hasOnchainDeviceKey=="function"?a.sanctos.hasOnchainDeviceKey:typeof a.hasOnchainDeviceKey=="function"?a.hasOnchainDeviceKey:null;if(C&&await C(e,i,60)){console.log("[SanctOS] \u{1F50D} Device pubkey already exists on-chain; setting local flag."),localStorage.setItem(g,"1");return}}catch(C){console.warn("[SanctOS] hasOnchainDeviceKey scan failed (non-fatal):",C)}if(Fe.has(p)){console.log("[SanctOS] \u{1F9E0} Device pubkey publish already in-flight, skipping:",p);return}Fe.add(p),console.log("[SanctOS] \u{1F4E3} Publishing device pubkey memo (wallet-only):",u);try{typeof a.sanctos?.ensureLocalDeviceIdentity=="function"&&await a.sanctos.ensureLocalDeviceIdentity(u,e)}catch(C){console.warn("[SanctOS] ensureLocalDeviceIdentity failed (non-fatal):",C)}let f=R(i,!1),w=ue(f.publicKey),_=`SANCTOS_PUBKEY:${u}:${w}:${Date.now()}`,m=new r({programId:F,keys:[],data:Buffer.from(_,"utf8")}),S=new l;try{if(localStorage.getItem(y)!=="1"){let C=a.__sanctosMaybeAddAccountFeeIx;typeof C=="function"&&(C(o,S,i),console.log("[SanctOS] \u2705 Account-fee ix possibly added (if configured)."))}else console.log("[SanctOS] \u{1F9E0} Account fee already marked paid; not adding fee ix.")}catch(C){console.warn("[SanctOS] Account-fee helper failed (non-fatal):",C)}console.log("[SanctOS] tx instruction count after fee helper:",S.instructions.length),S.add(m),console.log("[SanctOS] tx instruction count after memo:",S.instructions.length),S.feePayer=i;let{blockhash:b,lastValidBlockHeight:K}=await e.connection.getLatestBlockhash("finalized");S.recentBlockhash=b;let T=await e.wallet?.signTransaction?.(S)||await a.solana?.signTransaction?.(S);if(!T)throw new Error("Failed to sign transaction");let v=await e.connection.sendRawTransaction(T.serialize(),{skipPreflight:!1});localStorage.setItem(g,"1");try{let C=S.__sanctosAcctFeePaidKey;C&&localStorage.setItem(String(C),"1"),localStorage.setItem(y,"1"),localStorage.setItem(`sanctos:acctFeePaid:${u}`,"1"),localStorage.setItem(`sanctos:acctfee:paid:${u}`,"1")}catch{}try{typeof a.confirmTxRpcOnly=="function"?await a.confirmTxRpcOnly(e.connection,v):typeof ge=="function"?await ge(e.connection,v):await e.connection.confirmTransaction({signature:v,blockhash:b,lastValidBlockHeight:K},"confirmed")}catch(C){console.warn("[SanctOS] \u26A0\uFE0F Device pubkey confirm failed (non-fatal):",C)}console.log("[SanctOS] \u2705 Device pubkey publish:",v);try{let C=a.SANCTOS_CLUSTER_EXPLORER||"mainnet-beta";console.log(`\u{1F517} https://explorer.solana.com/tx/${v}?cluster=${C}`)}catch{}a.sanctos=a.sanctos||{},a.sanctos.publishDevicePubkeyIfNeeded=be}catch(o){console.error("[SanctOS] \u274C publishDevicePubkeyIfNeeded failed (non-fatal):",o)}finally{try{let o=typeof window<"u"?window:globalThis,c=o.solanaWeb3||o.web3||o.anchor&&o.anchor.web3;if(c?.PublicKey){let l=t?new c.PublicKey(t.toString()):null;if(l){let s=`sanctos:pubkey:announced:${l.toBase58()}`;Fe.delete(s)}}}catch{}}}async function on(e,t){let n=typeof window<"u"?window:globalThis,a=It(n),{PublicKey:o,Transaction:c,TransactionInstruction:l}=a;if(!e?.connection)throw new Error("provider.connection missing");let r=e.wallet?.publicKey||e.wallet?.adapter?.publicKey||n.solana?.publicKey||null;if(!r&&n.solana?.isPhantom&&(await n.solana.connect(),r=n.solana.publicKey),!r)throw new Error("Wallet not connected");let s=t?new o(t.toString()):new o(r.toString()),i=s.toBase58(),u=`sanctos:pubkey:announced:${i}`,g=`sanctos:identityPublish:${i}`;if(Fe.has(g))return{already:!1,sig:null};Fe.add(g);let p=new o("EBEQdAwgXmyLrj5npwmX63cEZwzrSKgEHy297Nfxrjhw");function y(){try{if(typeof n.getSanctosDelegateKeypair=="function"){let m=n.getSanctosDelegateKeypair();if(m?.publicKey)return m.publicKey}if(typeof n.sanctos?.getDelegateKeypair=="function"){let m=n.sanctos.getDelegateKeypair();if(m?.publicKey)return m.publicKey}let _=n.sanctos?.delegatePubkey||n.sanctos?.delegate58||n.__sanctosDelegate58||null;if(_)return new o(String(_))}catch{}return null}async function f(_,m){try{if(!m)return!1;let[S]=o.findProgramAddressSync([Buffer.from("delegate"),_.toBytes(),m.toBytes()],p);return!!(await e.connection.getAccountInfo(S,"confirmed"))?.data?.length}catch{return!1}}async function w(_){try{return typeof n.sanctos?.hasOnchainDeviceKey=="function"?!!await n.sanctos.hasOnchainDeviceKey(e,_,60):null}catch{return null}}try{let _=!0,m=!0;localStorage.getItem(u)==="1"&&(_=!1);let S=await w(s);S===!0&&(_=!1);let b=y();if(b?await f(s,b)&&(m=!1):m=!1,!_&&!m){try{localStorage.setItem(u,"1")}catch{}return{already:!0,sig:null}}typeof n.sanctos?.ensureLocalDeviceIdentity=="function"&&await n.sanctos.ensureLocalDeviceIdentity(i,e);let K=null;if(_){let $=R(s,!1),j=ue($.publicKey),se=`SANCTOS_PUBKEY:${i}:${j}:${Date.now()}`;K=new l({programId:F,keys:[],data:Buffer.from(se,"utf8")})}let T=new c;try{let $=n.__sanctosMaybeAddAccountFeeIx;typeof $=="function"&&$(a,T,s)}catch($){console.warn("[SanctOS] account fee helper failed (non-fatal):",$)}if(m)try{let $=n.sanctos?.buildDelegateInitForPublish;if(typeof $=="function"){let j=await $(e,s),se=Array.isArray(j?.ixs)?j.ixs:[],Q=Array.isArray(j?.signers)?j.signers:[];for(let Ke of se)T.add(Ke);Q.length&&(T.__sanctosExtraSigners=Q),T.__sanctosDelegateInitAdded=se.length>0}}catch($){console.warn("[SanctOS] delegate init hook failed (non-fatal):",$)}if(K&&T.add(K),!T.instructions||T.instructions.length===0){if(!_)try{localStorage.setItem(u,"1")}catch{}return{already:!0,sig:null}}T.feePayer=s;let{blockhash:v,lastValidBlockHeight:C}=await e.connection.getLatestBlockhash("finalized");T.recentBlockhash=v;let k=T,N=T.__sanctosExtraSigners;if(Array.isArray(N)&&N.length)try{k.partialSign(...N)}catch($){console.warn("[SanctOS] partialSign extra signers failed (non-fatal):",$)}if(k=await e.wallet?.signTransaction?.(k)||await n.solana?.signTransaction?.(k),!k)throw new Error("Failed to sign tx");let G=await e.connection.sendRawTransaction(k.serialize(),{skipPreflight:!1});try{(S===!0||K)&&localStorage.setItem(u,"1")}catch{}try{let $=T.__sanctosAcctFeePaidKey;$&&localStorage.setItem(String($),"1"),localStorage.setItem(Bt(i),"1"),localStorage.setItem(`sanctos:acctFeePaid:${i}`,"1"),localStorage.setItem(`sanctos:acctfee:paid:${i}`,"1")}catch{}try{T.__sanctosDelegateInitAdded&&localStorage.setItem(`sanctos:delegate:init:${i}`,"1")}catch{}try{await e.connection.confirmTransaction({signature:G,blockhash:v,lastValidBlockHeight:C},"confirmed")}catch{}return{already:!1,sig:G}}finally{Fe.delete(g)}}(()=>{let e=typeof window<"u"?window:globalThis;e.sanctos=e.sanctos||{},e.sanctos.publishDevicePubkeyIfNeeded=be,e.sanctos.publishIdentityWithDelegateInit=on})(),(()=>{try{let e=typeof window<"u"?window:globalThis,t=e.solanaWeb3||e.anchor&&e.anchor.web3;if(!t||!t.Connection||!t.PublicKey){console.warn("[SanctOS] \u26A0\uFE0F web3 guard skipped (no Connection/PublicKey)");return}let n=t.Connection,a=t.PublicKey,o=n.prototype.getSignaturesForAddress;o?.__sanctos_guarded__||(n.prototype.getSignaturesForAddress=async function(c,l={}){try{if(!c)throw new Error("Missing address argument");let r=c instanceof a?c:new a(c.toBase58?c.toBase58():c);return await o.call(this,r,l)}catch(r){return console.warn("[SanctOS] \u26A0\uFE0F Safe getSignaturesForAddress(): handled error \u2192 returning []",r),[]}},n.prototype.getSignaturesForAddress.__sanctos_guarded__=!0,console.log("[SanctOS] \u{1FA79} Patched Connection.getSignaturesForAddress() (safe base58 guard)"))}catch(e){console.error("[SanctOS] \u274C Failed to patch Connection.getSignaturesForAddress:",e)}})(),(()=>{let e=typeof window<"u"?window:globalThis;if(!e.solanaWeb3&&e.anchor?.web3&&(e.solanaWeb3=e.anchor.web3),!e.solanaWeb3&&e.web3&&(e.solanaWeb3=e.web3),e.solanaWeb3||(e.solanaWeb3={}),!e.solanaWeb3.PublicKey){let n=function(a){try{a?typeof a=="string"?this.value=a:a?.toBase58?this.value=a.toBase58():a?.publicKey?.toBase58?this.value=a.publicKey.toBase58():a?.toString?this.value=a.toString():this.value="InvalidPublicKey":this.value="UnknownPublicKey"}catch(o){console.warn("[SanctOS] \u26A0\uFE0F PublicKey fallback parse failed:",o),this.value="InvalidPublicKey"}};console.warn("[SanctOS] \u26A0\uFE0F PublicKey missing \u2014 installing legacy-safe fallback"),n.prototype.toBase58=function(){return String(this.value||"InvalidPublicKey")},n.prototype.toBuffer=function(){return new TextEncoder().encode(this.toBase58())},n.prototype.equals=function(a){return(a?.toBase58?a.toBase58():String(a))===this.toBase58()},n.prototype.toString=function(){return this.toBase58()},e.solanaWeb3.PublicKey=n}try{typeof t>"u"&&(t=e.solanaWeb3)}catch{var t=e.solanaWeb3}console.log("[SanctOS] \u{1F9ED} PublicKey legacy-safe fallback active")})(),(()=>{let e=typeof window<"u"?window:globalThis,t=e.solanaWeb3;if(!t?.PublicKey||!t?.TransactionInstruction){console.warn("[SanctOS] __sanctosManualTransferIx not installed (solanaWeb3 missing)");return}let{PublicKey:n,TransactionInstruction:a}=t,o=new n("11111111111111111111111111111111");function c(r){let s=new Uint8Array(4);return s[0]=r&255,s[1]=r>>>8&255,s[2]=r>>>16&255,s[3]=r>>>24&255,s}function l(r){let s=BigInt(r);if(s<0n)throw new Error("lamports must be >= 0");let i=new Uint8Array(8);for(let u=0;u<8;u++)i[u]=Number(s&255n),s>>=8n;return i}e.__sanctosManualTransferIx=function(r,s,i){let u=new Uint8Array(12);return u.set(c(2),0),u.set(l(i),4),new a({programId:o,keys:[{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0}],data:u})},console.log("[SanctOS] \u2705 __sanctosManualTransferIx installed")})();function Et(e,t){try{if(!e||!t){console.warn("[SanctOS] \u26A0\uFE0F patchConnectionGuard: missing conn/PublicKey");return}if(e.__sanctos_guarded__)return;let n=e.getSignaturesForAddress?.bind(e);if(typeof n!="function"){console.warn("[SanctOS] \u26A0\uFE0F patchConnectionGuard: no getSignaturesForAddress on conn");return}e.getSignaturesForAddress=async function(a,o={}){try{let c;if(!a)throw new Error("Missing address");return a instanceof t?c=a:a?.toBase58?c=new t(a.toBase58()):c=new t(String(a)),await n(c,o)}catch(c){return console.warn("[SanctOS] \u26A0\uFE0F instance getSignaturesForAddress error:",c),[]}},e.__sanctos_guarded__=!0,console.log("[SanctOS] \u{1F9E9} Patched conn.getSignaturesForAddress() (instance-safe)")}catch(n){console.warn("[SanctOS] \u26A0\uFE0F patchConnectionGuard failed:",n)}}(()=>{let e=typeof window<"u"?window:globalThis;e.sanctos||(Object.defineProperty(e,"sanctos",{configurable:!0,enumerable:!0,writable:!0,value:{}}),console.log("[SanctOS] \u{1FA90} Created window.sanctos placeholder for patchConnectionGuard")),e.sanctos.patchConnectionGuard=Et;let t=()=>{e.sanctos||(e.sanctos={}),e.sanctos.patchConnectionGuard=Et,console.log("[SanctOS] \u{1F501} Verified patchConnectionGuard still attached")};setTimeout(t,300),setTimeout(t,1e3),setTimeout(t,2500),e.addEventListener&&e.addEventListener("load",t,{once:!0}),console.log("[SanctOS] \u2705 patchConnectionGuard is globally available")})();async function le(e,t,n,a){if(!e||!e.connection)throw new Error("[SanctOS] provider.connection missing");let o=typeof window<"u"?window:globalThis,c=o.solanaWeb3||o.web3||o.anchor&&o.anchor.web3,l=c.PublicKey,r=c.TransactionInstruction;a=a||{};let s=!0;try{a.autoHandshake===!1&&(s=!1),o&&o.sanctosAutoHandshake===!1&&(s=!1)}catch{}let i=6e4,u=1200;try{typeof a.cooldownMs=="number"&&(i=a.cooldownMs),typeof a.rescanDelayMs=="number"&&(u=a.rescanDelayMs)}catch{}let g=b=>{try{return b?b instanceof l?b:typeof b=="string"?new l(b):b.toBase58?new l(b.toBase58()):null:null}catch{return null}};if(t=g(t)||e.wallet&&e.wallet.publicKey,n=g(n),!t||!n)throw new Error("[SanctOS] Invalid keys");let p=t.toBase58(),y=n.toBase58(),f="sanctos:peerKey:"+p+"->"+y,w=localStorage.getItem(f);if(w)try{let b=Uint8Array.from(atob(w),K=>K.charCodeAt(0));if(b.length===32)return console.log("[SanctOS] \u{1F4BE} Loaded peer device pubkey from cache:",y),globalThis.peerDevicePubkeyU8=b,b}catch{}let _=new c.Connection(Ge,{commitment:"confirmed",wsEndpoint:""}),m=[p,y],S=[n,t];for(let b=0;b<S.length;b++){let K=S[b];console.log("[SanctOS\u{1F50D}] Scanning memos under:",K.toBase58());let T=[];try{T=await _.getSignaturesForAddress(K,{limit:60})}catch(v){console.warn("[SanctOS] \u26A0\uFE0F getSignaturesForAddress failed:",v);continue}for(let v=0;v<T.length;v++){let C=T[v],k=await _.getTransaction(C.signature,{commitment:"confirmed",maxSupportedTransactionVersion:0});if(!k)continue;let N=k.transaction.message.staticAccountKeys||k.transaction.message.accountKeys||[],G=[].concat(k.transaction.message.instructions||[]).concat((k.meta&&k.meta.innerInstructions?k.meta.innerInstructions.flatMap($=>$.instructions):[])||[]);for(let $=0;$<G.length;$++){let j=G[$],se="";try{se=j.programId&&j.programId.toBase58&&j.programId.toBase58()||typeof j.programIdIndex=="number"&&N[j.programIdIndex]&&N[j.programIdIndex].toBase58&&N[j.programIdIndex].toBase58()||""}catch{}if(se!==F.toBase58())continue;let Q="";try{if(typeof j.data=="string"){let de=null;try{let ve=globalThis.bs58;if(ve?.decode){let Pe=ve.decode(j.data);de=new TextDecoder().decode(Pe)}}catch{}Q=de||j.data}else ArrayBuffer.isView(j.data)?Q=new TextDecoder().decode(j.data):Q=""}catch{Q=""}if(!Q||Q.indexOf("SANCTOS_")!==0)continue;let Ke=Q.split(":");if(Ke.length<3)continue;let De=Ke[1],ot=Ke[2];if(m.indexOf(De)===-1)continue;let _e=ot.replace(/-/g,"+").replace(/_/g,"/");for(;_e.length%4!==0;)_e+="=";let Ae=null;try{let de=atob(_e),ve=new Uint8Array(de.length);for(let Pe=0;Pe<de.length;Pe++)ve[Pe]=de.charCodeAt(Pe);Ae=ve}catch(de){console.warn("[SanctOS] \u26A0\uFE0F Failed to decode peer device pubkey:",de)}if(Ae&&Ae.length===32)return console.log("[SanctOS] \u2705 Peer device pubkey found via memo:",De),localStorage.setItem(f,btoa(String.fromCharCode.apply(null,Array.from(Ae)))),globalThis.peerDevicePubkeyU8=Ae,Ae}}}if(s){let b="sanctos:lastHandshake:"+p+"->"+y,K=sessionStorage.getItem(b);if(!K||Date.now()-parseInt(K)>i)try{let T=R(t),v="SANCTOS_HANDSHAKE:"+p+":"+ue(T.publicKey),C=new r({programId:F,keys:[],data:new TextEncoder().encode(v)}),k=new c.Transaction().add(C);k.feePayer=t;let N=await e.connection.getLatestBlockhash();k.recentBlockhash=N.blockhash;let G=await e.wallet.signTransaction(k),$=await e.connection.sendRawTransaction(G.serialize());return await e.connection.confirmTransaction($,"confirmed"),console.log("[SanctOS] \u{1FAF1} Auto-handshake memo published:",$),sessionStorage.setItem(b,String(Date.now())),await new Promise(j=>setTimeout(j,u)),await le(e,t,n,{autoHandshake:!1})}catch(T){console.warn("[SanctOS] \u26A0\uFE0F Auto-handshake publish failed:",T)}else console.log("[SanctOS] \u23F3 Handshake cooldown active")}return console.warn("[SanctOS] \u274C Peer device pubkey not found yet."),null}(()=>{try{let e=typeof window<"u"?window:globalThis;e.sanctos=e.sanctos||{},e.sanctos.findPeerDevicePubkey=le,console.log("[SanctOS] \u{1F501} findPeerDevicePubkey safely attached")}catch(e){console.warn("[SanctOS] \u26A0\uFE0F findPeerDevicePubkey attach failed:",e),setTimeout(()=>{let t=typeof window<"u"?window:globalThis;t.sanctos=t.sanctos||{},t.sanctos.findPeerDevicePubkey=le},500)}})();async function ut(e,t){try{let a=Z(typeof window<"u"?window:globalThis),{PublicKey:o}=a,c=t.connection,l=new o("EBEQdAwgXmyLrj5npwmX63cEZwzrSKgEHy297Nfxrjhw"),r=e instanceof o?e:new o(e.toString()),s=9,i=s+32,u=i+32,g=u+8,p=await Nt("DelegateAuth"),y=await c.getProgramAccounts(l,{filters:[{memcmp:{offset:0,bytes:p}},{memcmp:{offset:s,bytes:r.toBase58()}}]}),f=Math.floor(Date.now()/1e3),w=[];for(let _ of y){let m=_.account.data instanceof Uint8Array?_.account.data:new Uint8Array(_.account.data);if(m.length<g+1)continue;let S=m.slice(i,i+32),b=new o(S).toBase58(),K=new DataView(m.buffer,m.byteOffset+u,8),T=Number(K.getBigInt64(0,!0));!!!m[g]&&T>f&&w.push(b)}return Array.from(new Set(w))}catch(n){return console.warn("[SanctOS\u{1F9F5}] findOwnerDelegates failed:",n),[]}}(()=>{let e=typeof window<"u"?window:globalThis,t=e.sanctos||e||{};(async()=>{for(let o=0;o<40&&!(t.findPeerDevicePubkey&&t.getAnchorProvider);o++)await new Promise(c=>setTimeout(c,250));if(!t.findPeerDevicePubkey){console.warn("[SanctOS\u2699\uFE0F] findPeerDevicePubkey not found \u2014 skipping hotfix");return}let a=t.findPeerDevicePubkey;t.findPeerDevicePubkey=async function(c,l,r,s={}){try{return await a(c,l,r,s)}catch(i){if(String(i).includes("signTransaction")||String(i).includes("Unexpected error")){console.warn("[SanctOS\u2699\uFE0F] Retrying handshake with fresh provider context...");let u=await t.getAnchorProvider(),g=u.connection,p=u.wallet;try{let y=e.solanaWeb3||e.anchor&&e.anchor.web3||e.web3,f=new y.TransactionInstruction({programId:new y.PublicKey(Te),keys:[],data:Buffer.from(`SANCTOS_HANDSHAKE_RETRY:${Date.now()}`)}),w=new y.Transaction().add(f),{blockhash:_,lastValidBlockHeight:m}=await g.getLatestBlockhash();w.feePayer=p.publicKey,w.recentBlockhash=_;let S=await p.signTransaction(w),b=await g.sendRawTransaction(S.serialize(),{skipPreflight:!1});await g.confirmTransaction({signature:b,blockhash:_,lastValidBlockHeight:m}),console.log("[SanctOS] \u{1F504} Phantom handshake sync broadcasted:",b)}catch(y){console.warn("[SanctOS\u2699\uFE0F] Handshake TX build error:",y)}return await a(u,l,r,{...s,autoHandshake:!1})}throw i}},console.log("[SanctOS] \u{1FA79} Auto-handshake hotfix installed")})()})();async function vt(e){let t=await V();h(t);let a=Z(typeof window<"u"?window:globalThis),{PublicKey:o,Transaction:c,TransactionInstruction:l,SystemProgram:r}=a,s=t.wallet.publicKey,i=new o(e),[u]=he(s,i);if(console.log("[SanctOS\u{1F9F5}] Thread PDA (sorted):",u.toBase58()),(await t.connection.getAccountInfo(u))?.data?.length)return console.log("[SanctOS\u{1F9F5}] Thread exists:",u.toBase58()),u.toBase58();let p=we(s.toBuffer(),i.toBuffer())<=0;console.log(`[SanctOS\u{1F9F5}] Initializing thread from ${s.toBase58()} (acting as ${p?"lower":"higher"} wallet)`);let y=await A("init_thread"),f=new l({programId:L,keys:[{pubkey:s,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:r.programId,isSigner:!1,isWritable:!1}],data:y}),w=new c().add(f);w.feePayer=s;let{blockhash:_}=await t.connection.getLatestBlockhash();w.recentBlockhash=_;let m=await t.wallet.signTransaction(w),S=await t.connection.sendRawTransaction(m.serialize(),{skipPreflight:!1});return await t.connection.confirmTransaction(S,"confirmed"),console.log(`[SanctOS\u{1F9F5}] Thread initialized: ${u.toBase58()} (${S})`),console.log(`\u{1F517} https://explorer.solana.com/tx/${S}?cluster=${Pt}`),u.toBase58()}async function Mt(e){return vt(e)}async function sn(e,t){let n=await V(),o=Z(typeof window<"u"?window:globalThis),{PublicKey:c,Transaction:l,TransactionInstruction:r}=o,s=n.wallet.publicKey,i=new c(e),u=typeof t=="string"?new Uint8Array(Buffer.from(t,"hex")):new Uint8Array(t);if(u.length!==32)throw new Error("Pointer must be exactly 32 bytes");let[g,p]=we(s.toBuffer(),i.toBuffer())<=0?[s,i]:[i,s],[y]=c.findProgramAddressSync([Buffer.from("thread"),g.toBuffer(),p.toBuffer()],L),f=new r({programId:L,keys:[{pubkey:s,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!0}],data:Buffer.concat([await A("post_pointer"),u])}),w=new l().add(f);w.feePayer=s;let{blockhash:_}=await n.connection.getLatestBlockhash();w.recentBlockhash=_;let m=await n.wallet.signTransaction(w),S=await n.connection.sendRawTransaction(m.serialize(),{skipPreflight:!1});return await n.connection.confirmTransaction(S,"confirmed"),console.log("\u2705 Pointer posted:",S),console.log(`\u{1F517} https://explorer.solana.com/tx/${S}?cluster=${Pt}`),S}function He(e){let n=Z(typeof window<"u"?window:globalThis),a=e.toBase58?e.toBase58():String(e),o=B(a),c=localStorage.getItem(o);if(c)try{let r=JSON.parse(c),s=Uint8Array.from(r.secret);return n.Keypair.fromSecretKey(s)}catch(r){console.warn("[SanctOS] \u26A0\uFE0F Corrupt delegate key, regenerating\u2026",r),localStorage.removeItem(o)}let l=n.Keypair.generate();return localStorage.setItem(o,JSON.stringify({owner:a,pub:l.publicKey.toBase58(),secret:Array.from(l.secretKey),createdAt:Date.now()})),console.log("[SanctOS\u{1FAAA}] New delegate keypair created for owner",a),l}function ze(e,t){let a=Z(typeof window<"u"?window:globalThis),{PublicKey:o}=a,c=ye(e),l=ye(t);return o.findProgramAddressSync([Buffer.from("delegate"),c.toBuffer(),l.toBuffer()],L)}async function rn(e,t,n){let o=Z(typeof window<"u"?window:globalThis),{PublicKey:c}=o,l=new c("EBEQdAwgXmyLrj5npwmX63cEZwzrSKgEHy297Nfxrjhw"),r=ye(t),s=ye(n),i=await Nt("DelegateAuth");return await e.getProgramAccounts(l,{filters:[{memcmp:{offset:0,bytes:i}},{memcmp:{offset:9,bytes:r.toBase58()}},{memcmp:{offset:41,bytes:s.toBase58()}}]})}async function ft(e){let t=await V(),n=t.connection,a=t.wallet.publicKey,c=Z(typeof window<"u"?window:globalThis),{Transaction:l,TransactionInstruction:r,SystemProgram:s}=c,i=Math.floor(Date.now()/1e3),u=e&&e>i?e:i+60*60*24*30,p=He(a).publicKey,[y]=ze(a,p);if((await n.getAccountInfo(y,"confirmed"))?.data?.length)return console.log("[SanctOS\u{1FAAA}] Delegate auth already exists:",y.toBase58()),{owner:a.toBase58(),delegate:p.toBase58(),auth:y.toBase58()};console.log("[SanctOS\u{1FAAA}] Creating delegate auth:",{owner:a.toBase58(),delegate:p.toBase58(),expires:u});let w=Buffer.concat([await A("set_delegate"),Buffer.alloc(8)]);new DataView(w.buffer,w.byteOffset||0).setBigInt64(8,BigInt(u),!0);let _=new r({programId:L,keys:[{pubkey:a,isSigner:!0,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:s.programId,isSigner:!1,isWritable:!1}],data:w}),m=new l().add(_);m.feePayer=a;let{blockhash:S}=await n.getLatestBlockhash("finalized");m.recentBlockhash=S;let b=await t.wallet.signTransaction(m),K=await n.sendRawTransaction(b.serialize(),{skipPreflight:!1});typeof ge=="function"?await ge(n,K):await n.confirmTransaction(K,"finalized");try{let T=await rn(n,a,p);console.log("[SanctOS\u{1FAAA}] DelegateAuth verify matches:",T.length,T.map(v=>v.pubkey.toBase58()))}catch(T){console.warn("[SanctOS\u{1FAAA}] DelegateAuth verify failed (non-fatal):",T)}return console.log("[SanctOS\u{1FAAA}] Delegate auth created:",{sig:K,auth:y.toBase58()}),{owner:a.toBase58(),delegate:p.toBase58(),auth:y.toBase58(),sig:K}}async function cn(){let e=await V(),t=e.connection,n=e.wallet.publicKey,o=Z(typeof window<"u"?window:globalThis),{Transaction:c,TransactionInstruction:l}=o,s=He(n).publicKey,[i]=ze(n,s);if(!(await t.getAccountInfo(i,"confirmed"))?.data?.length){console.warn("[SanctOS\u{1FAAA}] No delegate auth to revoke");return}let g=await A("revoke_delegate"),p=new l({programId:L,keys:[{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0}],data:g}),y=new c().add(p);y.feePayer=n;let{blockhash:f}=await t.getLatestBlockhash("finalized");y.recentBlockhash=f;let w=await e.wallet.signTransaction(y),_=await t.sendRawTransaction(w.serialize(),{skipPreflight:!1});return typeof ge=="function"?await ge(t,_):await t.confirmTransaction(_,"finalized"),console.log("[SanctOS\u{1FAAA}] Delegate auth revoked:",{sig:_,auth:i.toBase58()}),{owner:n.toBase58(),delegate:s.toBase58(),auth:i.toBase58(),sig:_}}async function yt(){let e=await V(),t=e.connection,n=e.wallet.publicKey,o=He(n).publicKey,[c]=ze(n,o);return(await t.getAccountInfo(c,"confirmed"))?.data?.length?{owner:n.toBase58(),delegate:o.toBase58(),auth:c.toBase58()}:await ft()}async function gt(e){let t=await V(),n=t.connection,a=t.wallet.publicKey,c=Z(typeof window<"u"?window:globalThis),{PublicKey:l,Transaction:r,TransactionInstruction:s,SystemProgram:i}=c,u=new l(e),g=He(a),p=g.publicKey;await yt();let[y,f]=we(a.toBuffer(),u.toBuffer())<=0?[a,u]:[u,a],[w]=l.findProgramAddressSync([Buffer.from("thread"),y.toBuffer(),f.toBuffer()],L);if((await n.getAccountInfo(w,"confirmed"))?.data?.length)return w.toBase58();let[m]=ze(a,p),S={publicKey:p,signTransaction:async N=>(N.partialSign(g),N),signAllTransactions:async N=>{for(let G of N)G.partialSign(g);return N}},b=await A("init_thread_delegated"),K=new s({programId:L,keys:[{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!0,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:w,isSigner:!1,isWritable:!0},{pubkey:i.programId,isSigner:!1,isWritable:!1}],data:b}),T=new r().add(K);T.feePayer=p;let{blockhash:v}=await n.getLatestBlockhash("finalized");T.recentBlockhash=v;let C=await S.signTransaction(T),k=await n.sendRawTransaction(C.serialize(),{skipPreflight:!1});return typeof ge=="function"?await ge(n,k):await n.confirmTransaction(k,"finalized"),console.log("[SanctOS\u{1F9F5}] Delegated thread initialized:",{thread:w.toBase58(),sig:k}),w.toBase58()}async function Ct(e,t){let n=await V(),a=n.connection,o=n.wallet.publicKey,l=Z(typeof window<"u"?window:globalThis),{PublicKey:r,Transaction:s,TransactionInstruction:i}=l,u=new r(e),g=He(o),p=g.publicKey;await yt();let y=typeof t=="string"?new Uint8Array(Buffer.from(t,"hex")):new Uint8Array(t);if(y.length!==32)throw new Error("Pointer must be exactly 32 bytes");let[f,w]=we(o.toBuffer(),u.toBuffer())<=0?[o,u]:[u,o],[_]=r.findProgramAddressSync([Buffer.from("thread"),f.toBuffer(),w.toBuffer()],L);(await a.getAccountInfo(_,"confirmed"))?.data?.length||await gt(e);let[S]=ze(o,p),b={publicKey:p,signTransaction:async G=>(G.partialSign(g),G),signAllTransactions:async G=>{for(let $ of G)$.partialSign(g);return G}},K=Buffer.concat([await A("post_pointer_delegated"),y]),T=new i({programId:L,keys:[{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!0,isWritable:!0},{pubkey:S,isSigner:!1,isWritable:!1},{pubkey:_,isSigner:!1,isWritable:!0}],data:K}),v=new s().add(T);v.feePayer=p;let{blockhash:C}=await a.getLatestBlockhash("finalized");v.recentBlockhash=C;let k=await b.signTransaction(v),N=await a.sendRawTransaction(k.serialize(),{skipPreflight:!1});return typeof ge=="function"?await ge(a,N):await a.confirmTransaction(N,"finalized"),console.log("[SanctOS\u{1F4AC}] Delegated pointer posted:",{thread:_.toBase58(),sig:N}),N}function je(e,t,n){let a=e.toBase58?e.toBase58():String(e),o=t.toBase58?t.toBase58():String(t),c=x.enc(n);sessionStorage.setItem(`sanctos:peerdev:${a}->${o}`,c),sessionStorage.setItem(`sanctos:peerdev:${o}->${a}`,c)}function xt(e,t){let n=e.toBase58?e.toBase58():String(e),a=t.toBase58?t.toBase58():String(t);for(let o of[`sanctos:peerdev:${n}->${a}`,`sanctos:peerdev:${a}->${n}`]){let c=sessionStorage.getItem(o);if(c)try{return x.dec(c)}catch{}}return null}async function Rt(e,t,n){let a=typeof window<"u"?window:globalThis,o=t.toBase58(),c=n.toBase58();a.__sanctosHandshakeInflight=a.__sanctosHandshakeInflight||new Map;let l=`${o}->${c}`,r=a.__sanctosHandshakeInflight.get(l);if(r)return await r;let s=(async()=>{let i=`sanctos:pubkey:announced:${o}->${c}`,u=`sanctos:handshakeMemoSent:${o}->${c}`;if(sessionStorage.getItem(i)||(console.log("[SanctOS] \u{1F91D} Publishing my device pubkey (handshake init)"),await be(e,t,n),sessionStorage.setItem(i,"1")),!(await le(e,t,n)||await le(e,n,t))&&!sessionStorage.getItem(u))try{let p=R(t),y=`SANCTOS_HANDSHAKE:${o}:${x.enc(p.publicKey)}`,f=new M.TransactionInstruction({programId:F,keys:[],data:new TextEncoder().encode(y)}),w=new M.Transaction().add(f);w.feePayer=t;let{blockhash:_}=await e.connection.getLatestBlockhash("finalized");w.recentBlockhash=_;let m=await e.wallet.signTransaction(w),S=await e.connection.sendRawTransaction(m.serialize(),{skipPreflight:!1});await ge(e.connection,S),sessionStorage.setItem(u,"1"),console.log(`[SanctOS] \u{1FAF1} Sent handshake memo to peer ${c}: ${S}`)}catch(p){console.warn("[SanctOS] \u26A0\uFE0F handshake memo fallback failed:",p)}return!0})().finally(()=>{try{a.__sanctosHandshakeInflight.delete(l)}catch{}});return a.__sanctosHandshakeInflight.set(l,s),await s}async function ln(e){let t=await V(),n=t.connection,a=t.wallet.publicKey,o=typeof window<"u"?window:globalThis,c=o.solanaWeb3||o.web3||o.anchor&&o.anchor.web3;if(!c||!c.PublicKey)throw new Error("[SanctOS] PublicKey unavailable");let{PublicKey:l,Transaction:r,TransactionInstruction:s}=c,i=a.toBase58(),u=new l(e),g=u.toBase58();try{let b=`sanctos:pubkey:announced:${i}->${g}`,K=`sanctos:pubkey:announced:${g}->${i}`;sessionStorage.removeItem(b),sessionStorage.removeItem(K),console.log("[SanctOS\u{1F9FC}] Cleared handshake tags:",{tag1:b,tag2:K})}catch(b){console.warn("[SanctOS] \u26A0\uFE0F Could not clear handshake tags:",b)}let p=R(a),y=`SANCTOS_PUBKEY:${i}:${x.enc(p.publicKey)}`,f=new s({programId:F,keys:[],data:new TextEncoder().encode(y)}),w=new r().add(f);w.feePayer=a;let{blockhash:_}=await n.getLatestBlockhash("confirmed");w.recentBlockhash=_;let m=await t.wallet.signTransaction(w),S=await n.sendRawTransaction(m.serialize(),{skipPreflight:!1});console.log("[SanctOS\u{1FAF1}] forceRepublishDeviceKeyForPeer broadcast:",S);try{await n.confirmTransaction(S,"confirmed"),console.log("[SanctOS\u{1FAF1}] Device key reannounce confirmed")}catch(b){console.warn("[SanctOS\u{1FAF1}] confirmTransaction failed (still may land):",b)}try{dn(a,u),console.log("[SanctOS\u{1F9FC}] Cleared cached peerDev for pair",{me:i,peer:g})}catch{}}(()=>{let e=typeof window<"u"?window:globalThis;e.sanctos=e.sanctos||{},e.sanctos.forceRepublishDeviceKeyForPeer=ln,console.log("[SanctOS\u{1FAF1}] forceRepublishDeviceKeyForPeer attached globally")})();function dn(e,t){try{let n=e.toBase58(),a=t.toBase58(),o=`sanctos:peerDev:${n}->${a}`,c=`sanctos:peerDev:${a}->${n}`;localStorage.removeItem(o),localStorage.removeItem(c)}catch{}}async function ge(e,t,n=25e3){console.log("[SanctOS] \u{1F9E0} RPC-only confirmTransaction:",t);let a=Date.now();for(;Date.now()-a<n;){try{let c=(await e.getSignatureStatuses([t],{searchTransactionHistory:!0}))?.value?.[0];if(c){if(c.err)throw console.error("[SanctOS] \u274C Tx failed (status.err):",c.err),new Error("Transaction failed: "+JSON.stringify(c.err));if(c.confirmationStatus==="confirmed"||c.confirmationStatus==="finalized")return console.log("[SanctOS] \u2705 Tx confirmed (RPC poll):",t),c}}catch(o){console.warn("[SanctOS] \u26A0\uFE0F getSignatureStatuses error:",o)}await new Promise(o=>setTimeout(o,1e3))}return console.warn("[SanctOS] \u23F3 Tx not confirmed within timeout (still pending?):",t),null}(()=>{let e=typeof window<"u"?window:globalThis;if(e.__SANCTOS_MSGFEE_INSTALLED)return;e.__SANCTOS_MSGFEE_INSTALLED=!0,e.SANCTOS_MSG_FEE_TREASURY||(e.SANCTOS_MSG_FEE_TREASURY=e.SANCTOS_DELEGATE_TREASURY||"FhUFtN9MngoRj7YW1eYw57TxsYsTJ5xyMwMmdifxmwBi"),Number.isFinite(e.SANCTOS_MSG_FEE_LAMPORTS)||(e.SANCTOS_MSG_FEE_LAMPORTS=1e4);function t(){let r=e.SANCTOS_MSG_FEE_LAMPORTS;if(typeof r=="bigint")return r>0n?r:0n;if(Number.isFinite(r))return BigInt(Math.max(0,Math.floor(Number(r))));let s=e.SANCTOS_MSG_FEE_SOL;return Number.isFinite(s)?BigInt(Math.max(0,Math.floor(Number(s)*1e9))):0n}function n(){return"FhUFtN9MngoRj7YW1eYw57TxsYsTJ5xyMwMmdifxmwBi"}function a(r){let s=new Uint8Array(4);return new DataView(s.buffer).setUint32(0,r>>>0,!0),s}function o(r){let s=BigInt(r);if(s<0n)throw new Error("lamports must be >= 0");let i=new Uint8Array(8);for(let u=0;u<8;u++)i[u]=Number(s&255n),s>>=8n;if(s!==0n)throw new Error("lamports exceeds u64");return i}function c(r,s){let i=new Uint8Array(r.length+s.length);return i.set(r,0),i.set(s,r.length),i}function l(r,s){if(!s)throw new Error("pubkey missing");return s instanceof r.PublicKey?s:typeof s=="string"?new r.PublicKey(s):typeof s.toBase58=="function"?new r.PublicKey(s.toBase58()):s.publicKey&&typeof s.publicKey.toBase58=="function"?new r.PublicKey(s.publicKey.toBase58()):new r.PublicKey(String(s))}e.__sanctosMaybeAddMsgFeeIx=function(s,i,u){try{if(i.__sanctosMsgFeeAdded||(i.__sanctosMsgFeeAdded=!0,!s?.PublicKey||!s?.SystemProgram||!s?.TransactionInstruction)||!i?.add)return;let g=t();if(g<=0n)return;let p=n();if(!p)return;let y=l(s,u),f=new s.PublicKey(p),w=c(a(2),o(g)),_=new s.TransactionInstruction({programId:s.SystemProgram.programId,keys:[{pubkey:y,isSigner:!0,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0}],data:w});i.add(_)}catch(g){console.warn("[SanctOS] msg-fee: skipped (non-fatal):",g)}}})();function Z(e){let t=e?.sanctos?.__web3||e?.solanaWeb3||e?.web3||e?.anchor&&e.anchor.web3;if(!t?.PublicKey||!t?.Transaction||!t?.TransactionInstruction)throw new Error("No usable web3 namespace (need PublicKey/Transaction/TransactionInstruction)");return t}let un="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";function fn(e){let t=[0];for(let o=0;o<e.length;o++){let c=e[o];for(let l=0;l<t.length;l++){let r=t[l]*256+c;t[l]=r%58,c=r/58|0}for(;c;)t.push(c%58),c=c/58|0}let n=0;for(;n<e.length&&e[n]===0;)n++;let a="";for(let o=0;o<n;o++)a+="1";for(let o=t.length-1;o>=0;o--)a+=un[t[o]];return a}async function Nt(e){let n=new TextEncoder().encode(`account:${e}`),a=new Uint8Array(await crypto.subtle.digest("SHA-256",n));return fn(a.slice(0,8))}function ke(e,t){let{PublicKey:n}=e;if(t&&typeof t=="object"&&typeof t.then=="function")throw console.warn("[SanctOS] _asPubkey received a Promise (caller forgot await):",t),new Error("pubkey was a Promise (missing await in caller)");if(!t)throw new Error("pubkey missing");if(t instanceof n)return t;if(typeof t=="string")return new n(t);if(typeof t.toBase58=="function")return new n(t.toBase58());if(t.publicKey&&typeof t.publicKey.toBase58=="function")return new n(t.publicKey.toBase58());try{if(typeof t.toString=="function"){let a=String(t.toString()).trim();if(a)return new n(a)}}catch{}try{let a=String(t).trim();if(a)return new n(a)}catch{}try{console.warn("[SanctOS] _asPubkey could not coerce value:",t)}catch{}throw new Error("cannot coerce pubkey into PublicKey")}function Ut(e,t){let{TransactionInstruction:n}=e;return new n({programId:ke(e,t.programId),keys:(t.keys||[]).map(a=>({pubkey:ke(e,a.pubkey),isSigner:!!a.isSigner,isWritable:!!a.isWritable})),data:t.data})}function Ft(e,t){let{Transaction:n}=e,a=new n,o=t.instructions||t._instructions||[];for(let c of o)a.add(Ut(e,c));return t.recentBlockhash&&(a.recentBlockhash=t.recentBlockhash),t.feePayer&&(a.feePayer=ke(e,t.feePayer)),a}function yn(e,t,n){let a=typeof window<"u"?window:globalThis,o=n instanceof Uint8Array?n:new Uint8Array(n),c=a.b64u,l=c?.enc?c.enc(o):btoa(String.fromCharCode(...o)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,""),r=`SANCTOS_MSG:${e.toBase58()}:${l}`;return new ie({programId:F,keys:[{pubkey:t,isSigner:!0,isWritable:!1}],data:new TextEncoder().encode(r)})}async function Lt(e,t){let n=await V(),a=n.wallet.publicKey,o=new W(e);console.log("[SanctOS] \u2709\uFE0F postMessage() called:",{me:a.toBase58(),peer:o.toBase58()});{let N=typeof window<"u"?window:globalThis;!N.bs58&&typeof globalThis.bs58mod<"u"&&(N.bs58=globalThis.bs58mod,console.log("[SanctOS] \u{1F9E9} Bound bs58 globally before peer key scan"))}await Rt(n,a,o);let c=xt(a,o);if(c&&console.log("[SanctOS] \u26A1 Using cached peer device pubkey"),c||(c=await le(n,a,o)||await le(n,o,a),c&&(je(a,o,c),console.log("[SanctOS] \u{1F9E0} Cached peer device pubkey (bidirectional)"))),!c)throw new Error("Peer device pubkey not found \u2014 ask peer to publish once.");let[l,r]=we(a.toBuffer(),o.toBuffer())<=0?[a,o]:[o,a],[s]=W.findProgramAddressSync([Buffer.from("thread"),l.toBuffer(),r.toBuffer()],L);console.log("[SanctOS] \u{1F9E0} Using thread PDA:",s.toBase58());let i=await n.connection.getAccountInfo(s);if(!i?.data?.length)try{if(console.log("[SanctOS\u{1F9F5}] Thread missing, attempting initThread() from this wallet\u2026"),await Mt(e),i=await n.connection.getAccountInfo(s),!i?.data?.length)throw new Error("Thread init appeared to succeed but account is still empty")}catch(N){if(console.warn("[SanctOS] \u26A0\uFE0F initThread() from this wallet failed:",N),i=await n.connection.getAccountInfo(s),!i?.data?.length)throw new Error("Thread not initialized and initThread() failed");console.log("[SanctOS\u{1F9F5}] Thread was created by peer concurrently; proceeding.")}let u=R(a),g=Ue(u.secretKey,c),{nonce:p,cipher:y}=Dt(g,t),f=Buffer.concat([p,y]),_=(await Qe(f)).slice(0,32),m=yn(a,a,new Uint8Array(f)),S=new ie({programId:L,keys:[{pubkey:a,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0}],data:Buffer.concat([await A("post_pointer"),_])}),b=typeof window<"u"?window:globalThis,K=Z(b),T=new ne().add(m);b.__sanctosMaybeAddMsgFeeIx?.(K,T,a),T.add(S),T.feePayer=a;let v=await n.connection.getLatestBlockhash("finalized");T.recentBlockhash=v.blockhash,T.nonceInfo=void 0,T.lastValidBlockHeight=v.lastValidBlockHeight;let C=await n.wallet.signTransaction(T),k;try{k=await n.connection.sendRawTransaction(C.serialize(),{skipPreflight:!1,preflightCommitment:"confirmed"})}catch(N){console.warn("[SanctOS] \u26A0\uFE0F sendRawTransaction failed once, retrying with new blockhash:",N),v=await n.connection.getLatestBlockhash("finalized"),T.recentBlockhash=v.blockhash,T.nonceInfo=void 0,T.lastValidBlockHeight=v.lastValidBlockHeight,delete T.__sanctosMsgFeeAdded,C=await n.wallet.signTransaction(T),k=await n.connection.sendRawTransaction(C.serialize(),{skipPreflight:!1})}try{await ge(n.connection,k)}catch(N){console.warn("[SanctOS] \u26A0\uFE0F RPC-only confirm failed:",N)}return console.log("\u2705 Encrypted message posted:",k),console.log(`\u{1F517} https://explorer.solana.com/tx/${k}?cluster=${Pt}`),k}function $t(e,t,n,a,o){typeof a!="string"&&(a=String(a||""));let c=typeof window<"u"?window:globalThis,l=R(e),r=typeof c.sanctos?.getCachedPeerDevKey=="function"?c.sanctos.getCachedPeerDevKey:()=>null,s=o||r(e,t);if(!s)throw new Error("buildEncryptedMemoIx: peerDev missing (ensure handshake first)");let i=Ue(l.secretKey,s),u=c.nacl||globalThis.nacl;if(!u?.secretbox)throw new Error("tweetnacl.secretbox missing");let g=u.randomBytes(24),p=new TextEncoder().encode(a),y=u.secretbox(p,g,i),f=new Uint8Array(g.length+y.length);f.set(g,0),f.set(y,g.length);let w=c.b64u,_=w?.enc?w.enc(f):btoa(String.fromCharCode(...f)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,""),m=`SANCTOS_MSG:${e.toBase58()}:${_}`;return new ie({programId:F,keys:[{pubkey:n,isSigner:!0,isWritable:!1}],data:new TextEncoder().encode(m)})}(()=>{let e=typeof window<"u"?window:globalThis;e.sanctos=e.sanctos||{},e.sanctos.buildEncryptedMemoIx=$t})(),(()=>{let e=typeof window<"u"?window:globalThis;e.sanctos=e.sanctos||{};async function t(n){try{if(n&&typeof n=="object"&&typeof n.then=="function")return await n}catch{}return n}e.sanctos._buildEncryptedTx=async function(n,a,o,c,l){let r=Z(e),{Transaction:s}=r;if(!n?.connection)throw new Error("_buildEncryptedTx: provider missing");let i=ke(r,a),u=ke(r,o);typeof c!="string"&&(c=String(c||""));let g=typeof e.sanctos?.getCachedPeerDevKey=="function"?e.sanctos.getCachedPeerDevKey:()=>null,p=typeof e.sanctos?.cachePeerDevKey=="function"?e.sanctos.cachePeerDevKey:()=>{},y=g(i,u)||await e.sanctos?.findPeerDevicePubkey?.(n,i,u)||await e.sanctos?.findPeerDevicePubkey?.(n,u,i)||null;if(!y)throw new Error("_buildEncryptedTx: peer device pubkey missing (handshake)");try{p(i,u,y)}catch{}let f=await t(l);!f&&typeof e.sanctos?.getActiveSigner=="function"&&(f=await t(e.sanctos.getActiveSigner())),f||(f=i);let w=ke(r,f),_=$t(i,u,w,c,y),m=new s().add(_);m=Ft(r,m);let{blockhash:S}=await n.connection.getLatestBlockhash("finalized");return m.recentBlockhash=S,m},console.log("[SanctOS\u{1FAB6}] _buildEncryptedTx patched (delegate-safe + normalized + await activeSigner)")})();async function Je(e,t){let n=typeof window<"u"?window:globalThis,a=Z(n),{PublicKey:o,Transaction:c,SystemProgram:l}=a,r=await n.sanctos?.getAnchorProvider?.();if(!r?.connection||!r?.wallet?.publicKey)throw new Error("SanctOS provider not ready for delegated send");let s=r.connection,i=ke(a,r.wallet.publicKey),u=n.__sanctosDelegateKeypair;if(!u?.publicKey)throw new Error("No delegate keypair available on window.__sanctosDelegateKeypair");let g=new o(e),p=n.anchor;if(!p?.Program)throw new Error("anchor.Program not available");let y=n.SANCTOS_IDL||n.__SANCTOS_IDL||n.sanctos?.IDL;if(!y)throw new Error("SANCTOS_IDL missing on window (SANCTOS_IDL/__SANCTOS_IDL)");let f=n.sanctos?.PROGRAM_ID_STR||(n.sanctos?.PROGRAM_ID?.toBase58?n.sanctos.PROGRAM_ID.toBase58():null)||(typeof L?.toBase58=="function"?L.toBase58():null);if(!f)throw new Error("PROGRAM_ID missing (need PROGRAM_ID_STR or PROGRAM_ID)");let w=new p.Program(y,f,r),_=typeof n.sanctos?.findThreadPda=="function"?(await n.sanctos.findThreadPda(i,g))[0]:(await Tn(i,g))[0],m=typeof n.sanctos?.findDelegateAuthPda=="function"?(await n.sanctos.findDelegateAuthPda(i,u.publicKey))[0]:(await On(i,u.publicKey))[0],S=await s.getAccountInfo(_),b=[];if(!S){let G=await w.methods.initThreadDelegated().accounts({owner:i,peer:g,delegate:u.publicKey,auth:m,thread:_,systemProgram:l.programId}).instruction();b.push(G)}let K=Array.from(t);if(K.length!==32)throw new Error("Delegated pointer must be 32 bytes");let T=await w.methods.postPointerDelegated(K).accounts({owner:i,peer:g,delegate:u.publicKey,auth:m,thread:_}).instruction();b.push(T);let v=new c;for(let G of b)v.add(Ut(a,G));let{blockhash:C}=await s.getLatestBlockhash("finalized");v.feePayer=u.publicKey,v.recentBlockhash=C;let k=Ft(a,v);k.feePayer=ke(a,u.publicKey),k.recentBlockhash=C,k.sign(u);let N=await s.sendRawTransaction(k.serialize(),{skipPreflight:!1});return console.log("[SanctOS\u{1F680} Delegate TX] pointer confirmed:",N),N}(()=>{let e=typeof window<"u"?window:globalThis;e.sanctos=e.sanctos||{};try{typeof Je=="function"&&(e.postSanctosMsgDelegated=Je,e.sanctos.postSanctosMsgDelegated=Je,console.log("[SanctOS] \u{1F9E9} Exported postSanctosMsgDelegated to window + sanctos.*"))}catch(t){console.warn("[SanctOS] debug export failed:",t)}})(),(()=>{let e=typeof window<"u"?window:globalThis;if(e.SANCTOS_ENABLE_DELEGATE_FEE_INJECTOR!==!0){console.log("[SanctOS] \u{1F9EF} Delegate fee injector disabled (SANCTOS_ENABLE_DELEGATE_FEE_INJECTOR != true)");return}if(e.__SANCTOS_DELEGATE_FEE_INJECTOR_INSTALLED)return;e.__SANCTOS_DELEGATE_FEE_INJECTOR_INSTALLED=!0,Number.isFinite(e.SANCTOS_DELEGATE_MSG_FEE_LAMPORTS)||(e.SANCTOS_DELEGATE_MSG_FEE_LAMPORTS=1e4);function t(){let l=e.sanctos?.__web3||e.solanaWeb3||e.web3||e.anchor&&e.anchor.web3;if(!l?.PublicKey||!l?.TransactionInstruction)throw new Error("No usable web3 namespace (need PublicKey, TransactionInstruction)");return l}function n(l){let r=new Uint8Array(4);return r[0]=l&255,r[1]=l>>>8&255,r[2]=l>>>16&255,r[3]=l>>>24&255,r}function a(l){let r=BigInt(l),s=new Uint8Array(8);for(let i=0;i<8;i++)s[i]=Number(r&255n),r>>=8n;return s}function o(l,r){let s=new Uint8Array(l.length+r.length);return s.set(l,0),s.set(r,l.length),s}function c(l){if(typeof l=="bigint")return l>0n?l:0n;let r=Number(l);return!Number.isFinite(r)||r<=0?0n:BigInt(Math.floor(r))}e.__sanctosAddDelegateMsgFeeIx=e.__sanctosAddDelegateMsgFeeIx||function(r,s,i){try{if(!s?.instructions||!Array.isArray(s.instructions)||!i||s.__sanctosDelegated===!0||s.__sanctosSkipDelegateMsgFee===!0||s.__sanctosDelegateMsgFeeAdded)return 0n;s.__sanctosDelegateMsgFeeAdded=!0;let u=String(e.SANCTOS_DELEGATE_TREASURY||e.SANCTOS_TREASURY||"").trim();if(!u)return 0n;let g=e.SANCTOS_DELEGATE_MSG_FEE_LAMPORTS??0,p=c(g);if(p<=0n)return 0n;let y=r||t(),f=new y.PublicKey(u),w=new y.PublicKey("11111111111111111111111111111111"),_=o(n(2),a(p)),m=new y.TransactionInstruction({programId:w,keys:[{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0}],data:_});return s.instructions.unshift(m),console.log("[SanctOS Delegate] \u2705 (injector) msg-fee ix added:",{lamports:p.toString(),treasury:u}),p}catch(u){return console.warn("[SanctOS Delegate] fee injector skipped (non-fatal):",u),0n}},console.log("[SanctOS] \u2705 Delegate fee injector installed (gated)")})();async function Wt(e,t){let n=typeof window<"u"?window:globalThis,a=Z(n),{PublicKey:o}=a,c=await n.sanctos.getAnchorProvider();if(!c?.connection||!c?.wallet?.publicKey)throw new Error("provider not ready");let l=c.wallet.publicKey.toBase58(),r=String(e||"").trim();if(!r)throw new Error("peer58 missing");let s=n.__sanctosDelegateKeypair;if(!s?.secretKey)throw new Error("Delegate keypair missing (window.__sanctosDelegateKeypair)");let i=s.secretKey;if(Array.isArray(i)&&(i=Uint8Array.from(i)),!(i instanceof Uint8Array))try{i=Uint8Array.from(Array.from(i))}catch{}if(!(i instanceof Uint8Array))throw new Error("Delegate secretKey invalid");let u=a.Keypair.fromSecretKey(i),g=u.publicKey,p=new o(l),y=new o(r);await Rt(c,p,y);let f=await n.sanctos._buildEncryptedTx(c,l,r,String(t??""));if(!f?.instructions?.length)throw new Error("Delegated memo tx has no instructions");f.__sanctosDelegated=!0,f.__sanctosSkipAccountFee=!0,f.__sanctosSkipDelegateMsgFee=!1,f.__sanctosDelegateMsgFeeAdded=!1;let w="MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr",_=(f.instructions||[]).find(v=>v?.programId?.toBase58?.()===w);if(!_)throw new Error("Delegated tx missing Memo instruction");_.keys=[{pubkey:g,isSigner:!0,isWritable:!1}];let m=String(n.SANCTOS_DELEGATE_TREASURY||n.SANCTOS_TREASURY||"").trim();if(!m)throw new Error("Missing SANCTOS_DELEGATE_TREASURY");let S=Number(n.SANCTOS_DELEGATE_MSG_FEE_LAMPORTS??1e4),b=BigInt(Number.isFinite(S)&&S>0?Math.floor(S):0);if(b>0n){if(typeof n.__sanctosManualTransferIx!="function")throw new Error("__sanctosManualTransferIx missing");let v=new o(m);f.instructions.unshift(n.__sanctosManualTransferIx(g,v,b)),console.log("[SanctOS Delegate] \u2705 treasury fee ix added:",{lamports:b.toString(),treasury:m})}try{let v="11111111111111111111111111111111",C=y.toBase58();f.instructions=(f.instructions||[]).filter(k=>{try{if((k?.programId?.toBase58?.()||"")!==v)return!0;let G=k?.keys||[],$=G?.[0]?.pubkey?.toBase58?.()||"",j=G?.[1]?.pubkey?.toBase58?.()||"";if($!==g.toBase58()||j!==C)return!0;let se=k.data instanceof Uint8Array?k.data:new Uint8Array(k.data||[]);if(se.length<12)return!0;let Q=new DataView(se.buffer,se.byteOffset,se.byteLength),Ke=Q.getUint32(0,!0),De=Q.getBigUint64(4,!0);return Ke===2&&De===0n?(console.log("[SanctOS Delegate] \u{1F9F9} removed 0-lamport peer transfer ix"),!1):!0}catch{return!0}})}catch(v){console.warn("[SanctOS Delegate] 0-lamport guard skipped (non-fatal):",v)}let{blockhash:K}=await c.connection.getLatestBlockhash("confirmed");f.feePayer=g,f.recentBlockhash=K,f.signatures=[],f.sign(u);let T=await c.connection.sendRawTransaction(f.serialize(),{skipPreflight:!1});return console.log("[SanctOS Delegate] \u2705 sent (fee + memo only):",T),T}async function nt(e,t,n=1e5){let a=await crypto.subtle.importKey("raw",te.enc(String(e||"")),"PBKDF2",!1,["deriveKey"]),o=Number.isFinite(n)?Math.floor(n):1e5;return crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:o,hash:"SHA-256"},a,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async function Gt(){let t=(await V()).wallet.publicKey,n=t.toBase58(),a=R(t);return{v:1,kind:"sanctos-device-key",me:n,devPub:x.enc(a.publicKey),devSec:x.enc(a.secretKey),createdAt:Date.now()}}async function Ht(e){if(!e||typeof e!="string"||e.length<4)throw new Error("Passphrase must be at least 4 characters");let t=await Gt(),n=JSON.stringify(t),a=te.enc(n),o=crypto.getRandomValues(new Uint8Array(16)),c=crypto.getRandomValues(new Uint8Array(12)),l=await nt(e,o),r=await crypto.subtle.encrypt({name:"AES-GCM",iv:c},l,a),s=new Uint8Array(r),i={v:1,kind:"sanctos-device-key-export",algo:"PBKDF2-AES-GCM",me:t.me,salt:ue(o),iv:ue(c),ciphertext:ue(s)},u=JSON.stringify(i);return ue(te.enc(u))}async function wt(e,t){if(!e)throw new Error("Empty export string");if(!t||t.length<4)throw new Error("Passphrase must be at least 4 characters");let n=x.dec(e),a=te.dec(n),o=JSON.parse(a);if(o.kind!=="sanctos-device-key-export")throw new Error("Not a SanctOS device key export");let c=x.dec(o.salt),l=x.dec(o.iv),r=x.dec(o.ciphertext),s=await nt(t,c),i;try{i=await crypto.subtle.decrypt({name:"AES-GCM",iv:l},s,r)}catch{throw new Error("Failed to decrypt export \u2014 wrong passphrase?")}let u=te.dec(new Uint8Array(i)),g=JSON.parse(u);if(g.kind!=="sanctos-device-key"||!g.me||!g.devPub||!g.devSec)throw new Error("Invalid device key payload");let p=g.me,y=E(p),f=JSON.stringify({pub:g.devPub,sec:g.devSec});return localStorage.setItem(y,f),console.log("[SanctOS\u{1F511}] Device keypair imported for",p),await zt(p),{me:p}}async function gn(e,t="sanctos_device_key.txt"){let n=await Ht(e),a=new Blob([n],{type:"text/plain"}),o=URL.createObjectURL(a),c=document.createElement("a");c.href=o,c.download=t,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(o),console.log("[SanctOS\u{1F511}] Device key export saved as file:",t)}(()=>{let e=typeof window<"u"?window:globalThis;e.sanctos=e.sanctos||{},e.sanctos.exportDeviceKeyString=Ht,e.sanctos.importDeviceKeyFromExport=wt,e.sanctos.exportDeviceKeyToFile=gn,console.log("[SanctOS\u{1F511}] Device key export/import helpers attached")})();async function zt(e){let t=typeof window<"u"?window:globalThis,n=t.sanctos||{};try{let a=typeof n.getAnchorProvider=="function"&&n.getAnchorProvider||typeof t.getAnchorProvider=="function"&&t.getAnchorProvider,o=null,c=null;if(a&&(o=await a(),c=o?.wallet?.publicKey||null),!c&&t.solanaWeb3?.PublicKey)try{c=new t.solanaWeb3.PublicKey(e)}catch(l){console.warn("[SanctOS\u{1F501}] Failed to build PublicKey from me58:",l)}if(c||console.warn("[SanctOS\u{1F501}] No mePk available after import; skipping deep refresh"),typeof n.getDeviceKeypair=="function"&&c)try{n.getDeviceKeypair(c),console.log("[SanctOS\u{1F501}] getDeviceKeypair reloaded after import")}catch(l){console.warn("[SanctOS\u{1F501}] getDeviceKeypair failed after import:",l)}if(typeof n.publishDevicePubkeyIfNeeded=="function"&&o&&c)try{let l=`sanctos:pubkey:announced:${e}->${e}`;sessionStorage.removeItem(l),console.log("[SanctOS\u{1F501}] Cleared self-announced tag after import:",l),await n.publishDevicePubkeyIfNeeded(o,c,c),console.log("[SanctOS\u{1F4E1}] Device pubkey re-published after import for",e)}catch(l){console.warn("[SanctOS\u{1F4E1}] publishDevicePubkeyIfNeeded failed after import:",l)}if(t.__sanctosRepair&&typeof t.__sanctosRepair.resetPeerCache=="function")try{t.__sanctosRepair.resetPeerCache(),console.log("[SanctOS\u{1F9E0}] Peer cache reset via __sanctosRepair.resetPeerCache()")}catch(l){console.warn("[SanctOS\u{1F9E0}] resetPeerCache failed:",l)}try{if(o&&c&&typeof t.loadConvoIndex=="function"&&typeof n.autoRepairPeerKey=="function"&&t.solanaWeb3?.PublicKey){let l=t.loadConvoIndex()||[],r=new Set;for(let s of l)s&&s.peer&&r.add(s.peer);for(let s of r)try{let i=new t.solanaWeb3.PublicKey(s);await n.autoRepairPeerKey(o,c,i);let u=`sanctos:forceFullRescan:${e}->${s}`,g=`sanctos:forceFullRescan:${s}->${e}`;sessionStorage.setItem(u,Date.now().toString()),sessionStorage.setItem(g,Date.now().toString()),console.log("[SanctOS\u{1F9FC}] Marked pair for full rescan after import:",{me:e,peer:s})}catch(i){console.warn("[SanctOS\u{1F9E0}] autoRepairPeerKey failed for",s,i)}console.log("[SanctOS\u{1F9E0}] autoRepairPeerKey nudged for peers after import")}}catch(l){console.warn("[SanctOS\u{1F9E0}] Peer auto-repair sweep failed:",l)}try{typeof t.sanctosPokeSync=="function"?t.sanctosPokeSync():typeof t.sanctosPokeWorkerScan=="function"&&t.sanctosPokeWorkerScan()}catch(l){console.warn("[SanctOS\u{1F6F0}] Poke sync after import failed:",l)}}catch(a){console.warn("[SanctOS\u{1F501}] refreshIdentityAfterImport failed:",a)}}function Ln(e){try{let t=typeof window<"u"?window:globalThis;if(!e)return"";if(typeof e=="string"){if(e.startsWith("SANCTOS_"))return e;let n=t.bs58||typeof t.bs58mod<"u"&&t.bs58mod;if(n?.decode&&/^[1-9A-HJ-NP-Za-km-z]+$/.test(e)){let a=n.decode(e);return new TextDecoder().decode(a)}return""}return e instanceof Uint8Array?new TextDecoder().decode(e):Array.isArray(e)?new TextDecoder().decode(new Uint8Array(e)):e?.data&&Array.isArray(e.data)?new TextDecoder().decode(new Uint8Array(e.data)):""}catch{return""}}let wn=(typeof window<"u"?window.__sanctosTxCache:globalThis.__sanctosTxCache)||new Map;typeof window<"u"&&(window.__sanctosTxCache=wn);async function ht(e,t={}){let n=await V(),a=n.wallet.publicKey,o=new W(e);if(a.equals(o))return console.warn("[SanctOS] \u26A0\uFE0F fetchMessages called with self peer; returning []"),[];let c=t.limit??25,l=t.skipKnownSigs,r=typeof window<"u"?window:globalThis,s=a.toBase58(),i=o.toBase58(),u=`sanctos:badSigs:${s}->${i}`,g=new Set;try{let P=localStorage.getItem(u)||sessionStorage.getItem(u);if(P){let O=JSON.parse(P);Array.isArray(O)&&(g=new Set(O.filter(D=>typeof D=="string")))}}catch{}let p=r.__sanctosTD||=new TextDecoder;function y(P){try{if(!P)return"";if(typeof P=="string"){if(P.startsWith("SANCTOS_"))return P;let O=r.bs58||typeof r.bs58mod<"u"&&r.bs58mod;if(O?.decode&&/^[1-9A-HJ-NP-Za-km-z]+$/.test(P)){let D=O.decode(P);return p.decode(D)}return""}return P instanceof Uint8Array?p.decode(P):Array.isArray(P)?p.decode(new Uint8Array(P)):P?.data&&Array.isArray(P.data)?p.decode(new Uint8Array(P.data)):""}catch{return""}}let f=!1;try{let P=`sanctos:forceFullRescan:${s}->${i}`,O=`sanctos:forceFullRescan:${i}->${s}`;(sessionStorage.getItem(P)||sessionStorage.getItem(O))&&(f=!0,sessionStorage.removeItem(P),sessionStorage.removeItem(O),console.log("[SanctOS\u{1F9FC}] Forcing ONE-TIME full rescan after device-key import:",{me:s,peer:i}))}catch{}let w=!!t.full||!!t.fullScan||!!t.forceFullRescan;w&&(f=!0);let _=`${s}->${i}`;{let P=Date.now(),O=w?0:50,D=Ee.get(_)??0;if(!f&&P-D<O)return[];Ee.set(_,P)}r.__sanctosPairCursor||=new Map;let m=f||w?"":r.__sanctosPairCursor.get(_)||"";r.__sanctosPairHeads||=new Map,r.__sanctosDelegateCache||=new Map;let S=6*60*60*1e3;async function b(P){try{let O=P?.toBase58?P.toBase58():String(P||"");if(!O)return[];let D=r.__sanctosDelegateCache.get(O),U=Date.now();if(D&&U-D.ts<S)return D.list||[];let re=await ut(P,n),Y=Array.from(new Set((re||[]).filter(Boolean)));return r.__sanctosDelegateCache.set(O,{ts:U,list:Y}),Y}catch{return[]}}let K=typeof Te=="string"&&Te||(typeof F?.toBase58=="function"?F.toBase58():"")||(typeof globalThis.MEMO_PROGRAM_ID_STR=="string"?globalThis.MEMO_PROGRAM_ID_STR:"")||(typeof globalThis.MEMO_PROGRAM_ID?.toBase58=="function"?globalThis.MEMO_PROGRAM_ID.toBase58():""),T=Date.now(),v=60,C=10*60*1e3,k=2500;function N(){try{if(!fe||typeof fe.size!="number"||fe.size<k)return;let P=[];for(let[D,U]of fe.entries())typeof D=="string"&&D.startsWith("tx:")&&U?.ts&&P.push([D,U]);P.sort((D,U)=>(D[1].ts||0)-(U[1].ts||0));let O=Math.min(P.length,Math.floor(k*.2));for(let D=0;D<O;D++)fe.delete(P[D][0])}catch{}}async function G(P,O,D){let U=fe.get(O),re=D??t.limit??25;if(U&&T-(U.ts||0)<v&&Array.isArray(U.sigs))return U.sigs;let Y={limit:re,commitment:"confirmed"},Me=!f&&!w&&m?{...Y,until:m}:Y;try{let ce=await n.connection.getSignaturesForAddress(P,Me);return fe.set(O,{sigs:ce,ts:Date.now()}),ce}catch{try{let ce=await n.connection.getSignaturesForAddress(P,Y);return fe.set(O,{sigs:ce,ts:Date.now()}),ce}catch(ce){return U?.sigs?U.sigs:(console.warn("[SanctOS\u{1F4E1}] getSignaturesForAddress failed:",ce),[])}}}r.__sanctosHeadAddrTs||=new Map;let $=r.__sanctosHeadAddrTs;async function j(P,O){let D=$.get(O)||0,U=Re.get(O)||"";if(U&&Date.now()-D<v)return U;try{let re=await n.connection.getSignaturesForAddress(P,{limit:1,commitment:"confirmed"}),Y=String(re?.[0]?.signature||"");return Y&&Re.set(O,Y),$.set(O,Date.now()),Y||U||""}catch{return U||""}}let se=null;try{let P=r.__sanctosDelegateKeypair;P?.publicKey&&(se=P.publicKey.toBase58())}catch{}let Q=[s,i];se&&Q.push(se);try{let[P,O]=await Promise.all([b(a),b(o)]);for(let D of P||[])Q.push(D);for(let D of O||[])Q.push(D)}catch{}let De=(r.solanaWeb3||r.web3||r.anchor&&r.anchor.web3)?.PublicKey??null;if(!De)throw new Error("PublicKey unavailable");let ot=Array.from(new Set(Q)).filter(Boolean);if(!w)try{let[P]=he(a,o),D=(await Promise.all([j(P,`head:thread:${P.toBase58()}`),...ot.map(U=>j(new De(U),`head:addr:${U}`))])).filter(Boolean).join("|");if(!f&&D){let U=Re.get(`fp:${_}`)||"";if(U&&U===D)return[];Re.set(`fp:${_}`,D)}}catch{}let _e=new Map,Ae=Math.max(80,c*6);try{let[P]=he(a,o),O=`thread:${P.toBase58()}`,D=await G(P,O,Ae);for(let U of D){let re=U?.signature;re&&!_e.has(re)&&_e.set(re,U)}}catch(P){console.warn("[SanctOS\u{1F4E1}] Thread scan failed:",P)}try{let P=await Promise.all(ot.map(async O=>{let D=new De(O);return await G(D,`addr:${O}`,Ae)}));for(let O of P)for(let D of O||[]){let U=D?.signature;U&&!_e.has(U)&&_e.set(U,D)}}catch(P){console.warn("[SanctOS\u{1F4E1}] Multi-address scan failed:",P)}let de=Array.from(_e.values()).filter(P=>!!P?.signature);de.sort((P,O)=>{let D=Number(P?.slot||0),U=Number(O?.slot||0);if(U!==D)return U-D;let re=Number(P?.blockTime||0),Y=Number(O?.blockTime||0);return Y!==re?Y-re:String(O?.signature||"").localeCompare(String(P?.signature||""))});let ve=f?[]:r.__sanctosPairHeads.get(_)||[],Pe=new Set(ve);try{let P=de.slice(0,6).map(O=>String(O?.signature||"")).filter(Boolean);P.length&&r.__sanctosPairHeads.set(_,P)}catch{}r.__sanctosTxInflight||=new Map;async function Jt(P){let O=`tx:${P}`,D=fe.get(O),U=Date.now(),re=D&&U-(D.ts||0)<C;if(D?.data&&re)return D.data;let Y=r.__sanctosTxInflight.get(P);if(Y)return await Y;let Me=n.connection.getTransaction(P,{maxSupportedTransactionVersion:0,commitment:"confirmed"}).then(ce=>(fe.set(O,{data:ce,ts:Date.now()}),r.__sanctosTxInflight.delete(P),N(),ce)).catch(ce=>{if(r.__sanctosTxInflight.delete(P),D?.data)return D.data;throw ce});return r.__sanctosTxInflight.set(P,Me),await Me}let st=R(a),Ie=xt(a,o);Ie||(Ie=await le(n,a,o)||await le(n,o,a),Ie&&je(a,o,Ie));let rt=[],Yt=typeof t.onMessage=="function"?t.onMessage:null,Vt=new Set,Le=!1,bt=null,mt=null;async function Kn(){return Le?null:(Le=!0,bt||(bt=Sn(n,a,o).catch(()=>null)),await bt)}async function Dn(){Le||(Le=!0,mt||(mt=Ye(n,a,o).catch(()=>{})),await mt)}try{for(let O=0;O<Math.min(60,de.length);O++){let D=String(de[O]?.signature||"");D&&(!f&&(l?.has(D)||g.has(D))||Jt(D).catch(()=>{}))}}catch{}let Ve=[],In=Math.max(160,c*10);for(let P of de){let O=P?.signature;if(O){if(!f&&!w&&(m&&O===m||Pe.size&&Pe.has(O)))break;if(!(!f&&(l?.has(O)||g.has(O)))&&(Ve.push(P),Ve.length>=In))break}}let ct=0,it="";async function Bn(P){let O=P?.signature;if(!O||!f&&!w&&ct>=c)return;let D=null;try{D=await Jt(O)}catch{return}if(!D)return;it||(it=O);let U=Number(D?.blockTime||0)*1e3||Number(P?.blockTime||0)*1e3||Date.now(),re=D.transaction.message.staticAccountKeys||D.transaction.message.accountKeys||[],Y=D.transaction.message.instructions||[],Me=D.meta?.innerInstructions||[],ce=Y;if(Me?.length){let Be=Me.flatMap(qt=>qt.instructions||[]);ce=Y.length?Y:Be,Y.length&&Be.length&&(ce=Y.concat(Be))}for(let Be of ce){if(!f&&!w&&ct>=c)break;try{let Mn=(Be.programId||(typeof Be.programIdIndex=="number"?re[Be.programIdIndex]:null))?.toBase58?.()||"";if(!K||Mn!==K)continue;let Xe=y(Be.data);if(!Xe||!Xe.startsWith("SANCTOS_MSG:"))continue;let _t=Xe.split(":");if(_t.length<3)continue;let Zt=String(_t[1]||""),Cn=_t.at(-1),qe;try{qe=x.dec(Cn)}catch{continue}if(!qe||qe.length<25)continue;let xn=qe.slice(0,24),Rn=qe.slice(24),Qt=O+":"+Zt;if(Vt.has(Qt))continue;Vt.add(Qt);let Ce=!1,At;if(Ie&&st?.secretKey){let Ze=st.secretKey.length>32?st.secretKey.slice(0,32):st.secretKey,tn=$e=>{let Nn=$e.length>32?$e.slice(0,32):$e,Un=Ue(Ze,Nn);return dt(Un,xn,Rn)},lt=tn(Ie);if(lt==null&&!Le){let $e=await Kn();$e&&(Ie=$e,lt=tn(Ie))}lt!=null&&(Ce=!0,At=lt)}if(!Ce&&typeof r.__sanctosDecryptPacked=="function")try{let Ze=await r.__sanctosDecryptPacked(Xe,s,i);Ze&&!Ze.startsWith("[\u{1F512}")&&(Ce=!0,At=Ze)}catch{}!Ce&&!Le&&await Dn(),Ce||g.add(O);let en={sig:O,from:Zt,at:U,ok:Ce,text:At,raw:Xe};rt.push(en),Yt&&Yt(en),Ce&&ct++}catch{}}}let En=10,Xt=0,vn=new Array(Math.min(En,Ve.length)).fill(0).map(async()=>{for(;Xt<Ve.length&&!(!f&&!w&&ct>=c);){let P=Ve[Xt++];await Bn(P)}});await Promise.all(vn);try{!f&&!w&&it&&r.__sanctosPairCursor.set(_,it)}catch{}try{let P=Array.from(g),O=JSON.stringify(P);localStorage.setItem(u,O),sessionStorage.setItem(u,O)}catch{}return rt.sort((P,O)=>(P.at||0)-(O.at||0)),console.log(`[SanctOS] \u{1F4E9} Resolved ${rt.length} SANCTOS_MSG memos between ${s} and ${i}`),rt}function hn(e){try{if(!e)return"";if(typeof e=="string"){if(e.startsWith("SANCTOS_"))return e;let t=typeof window<"u"?window:globalThis,n=t.bs58||typeof t.bs58mod<"u"&&t.bs58mod;if(n?.decode&&/^[1-9A-HJ-NP-Za-km-z]+$/.test(e)){let a=n.decode(e);return new TextDecoder().decode(a)}return""}return e instanceof Uint8Array?new TextDecoder().decode(e):Array.isArray(e)?new TextDecoder().decode(new Uint8Array(e)):e?.data&&Array.isArray(e.data)?new TextDecoder().decode(new Uint8Array(e.data)):""}catch{return""}}async function pn(e,t,n,a=120){let o=e?.connection;if(!o)return null;let c=typeof window<"u"?window:globalThis,r=(c.solanaWeb3||c.web3||c.anchor&&c.anchor.web3)?.PublicKey;if(!r)return null;let s=typeof Te=="string"&&Te||(typeof F?.toBase58=="function"?F.toBase58():""),i=Array.from(new Set(n)).filter(Boolean);for(let u of i){let g=[];try{g=await o.getSignaturesForAddress(new r(u),{limit:a})}catch{continue}for(let p of g){let y=await o.getTransaction(p.signature,{commitment:"confirmed",maxSupportedTransactionVersion:0});if(!y)continue;let f=y.transaction.message.staticAccountKeys||y.transaction.message.accountKeys||[],w=y.transaction.message.instructions||[],_=(y.meta?.innerInstructions||[]).flatMap(S=>S.instructions||[]),m=[...w,..._];for(let S of m){let b="";try{S.programId?b=S.programId.toBase58?.()||String(S.programId):typeof S.programIdIndex=="number"&&(b=f[S.programIdIndex]?.toBase58?.()||"")}catch{}if(b!==s)continue;let K=hn(S.data);if(K.startsWith("SANCTOS_")&&(K.startsWith("SANCTOS_PUBKEY:")||K.startsWith("SANCTOS_HANDSHAKE:"))){let T=K.split(":");if(T.length<3||String(T[1]||"")!==t)continue;let C=String(T.at(-1)||""),k=null;try{k=x.dec(C)}catch{k=null}if(k&&k.length===32)return k}}}}return null}async function Sn(e,t,n){let a=t.toBase58(),o=n.toBase58(),c=[a,o];try{let r=await ut(t,e),s=await ut(n,e);for(let i of r||[])c.push(i);for(let i of s||[])c.push(i)}catch{}let l=await pn(e,o,c,140);if(l){try{je(t,n,l)}catch{}return console.log("[SanctOS\u{1FA79}] forceRefreshPeerDevKey \u2192 updated peerDev for",o),l}return null}async function bn(e){let t=await V(),n=t.wallet.publicKey,a=typeof window<"u"?window:globalThis,o=a.solanaWeb3||a.web3||a.anchor&&a.anchor.web3;if(!o?.PublicKey)throw new Error("[SanctOS] PublicKey unavailable in readThread");let{PublicKey:c}=o,l=new c(e),[r]=he(n,l);console.log(`[SanctOS\u{1F4D6}] Reading thread PDA: ${r.toBase58()}`);let s=await t.connection.getAccountInfo(r);if(!s)return console.warn("[SanctOS\u{1F4D6}] Thread PDA not found:",r.toBase58()),null;let i=new Uint8Array(s.data);if(console.log("[SanctOS\u{1F4D6}] Raw thread data:",i),i.length>=32){let u=Array.from(i.slice(0,32)).map(g=>g.toString(16).padStart(2,"0")).join("");console.log("[SanctOS\u{1F4D6}] Pointer digest:",u)}else console.log("[SanctOS\u{1F4D6}] Thread data too short, likely uninitialized");return{pda:r.toBase58(),data:i}}async function mn(e){let t=await V(),n=t.wallet.publicKey,a=typeof window<"u"?window:globalThis,o=a.solanaWeb3||a.web3||a.anchor&&a.anchor.web3;if(!o?.PublicKey)throw new Error("[SanctOS] PublicKey unavailable in debugThread");let{PublicKey:c}=o,l=new c(e),[r]=he(n,l),s=await t.connection.getAccountInfo(r);if(!s)return console.warn("[SanctOS\u{1F9E9}] No thread found for peer:",e);let i=new Uint8Array(s.data),u=Array.from(i).map(g=>g.toString(16).padStart(2,"0")).join("");return console.log(`[SanctOS\u{1F9E9}] Thread PDA: ${r.toBase58()}`),console.log(`[SanctOS\u{1F9E9}] Data (${i.length} bytes):`,u),console.log(`[SanctOS\u{1F9E9}] Hex preview (first 32B): ${u.slice(0,64)}...`),{pda:r.toBase58(),len:i.length,hex:u}}async function _n(e=30){for(let t=0;t<e;t++){let n=typeof window<"u"?window:globalThis;if(n.bs58&&typeof n.bs58.decode=="function")return!0;await new Promise(a=>setTimeout(a,150))}return console.warn("[SanctOS] \u26A0\uFE0F bs58 not ready after timeout, fallback in use"),!1}async function An(e,t,n,a=60){await _n();let o=typeof window<"u"?window:globalThis,c=o.solanaWeb3||o.web3||o.anchor&&o.anchor.web3;if(!c||!c.PublicKey)throw new Error("[SanctOS] PublicKey unavailable");let{PublicKey:l}=c,r=e&&e.connection;if(!r)throw new Error("[SanctOS] provider.connection missing");function s(){let S=o.bs58||typeof ae<"u"&&ae||null;return S?S.decode?S:S.default:null}if(!t)if(e?.wallet?.publicKey)t=e.wallet.publicKey;else throw new Error("[SanctOS] Missing 'me' public key");if(!n)throw new Error("[SanctOS] Missing 'peer' public key");let i=t instanceof l?t:new l(t.toString()),u=n instanceof l?n:new l(n.toString());console.log("\u{1FAB6} Starting raw memo scan between:",{me:i.toBase58(),peer:u.toBase58()});let[g,p]=await Promise.allSettled([r.getSignaturesForAddress(i,{limit:a}),r.getSignaturesForAddress(u,{limit:a})]),y=g.status==="fulfilled"?g.value:[],f=p.status==="fulfilled"?p.value:[],w=[...y,...f];console.log(`\u{1FAB6} Found ${w.length} total txs across both wallets`);function _(S){try{if(!S)return"";if(typeof S=="string"){if(S.startsWith("SANCTOS_"))return S;let b=s();if(b?.decode){let K=b.decode(S);return new TextDecoder().decode(K)}return""}return S instanceof Uint8Array?new TextDecoder().decode(S):Array.isArray(S)?new TextDecoder().decode(new Uint8Array(S)):S?.data&&Array.isArray(S.data)?new TextDecoder().decode(new Uint8Array(S.data)):""}catch(b){return console.warn("\u26A0\uFE0F Memo decode failed:",b),""}}let m=0;for(let S of w){let b=await r.getTransaction(S.signature,{commitment:"confirmed",maxSupportedTransactionVersion:0});if(!b)continue;let K=b.transaction.message.staticAccountKeys||b.transaction.message.accountKeys||[],T=b.transaction.message.instructions||[],v=(b.meta?.innerInstructions||[]).flatMap(k=>k.instructions||[]),C=[...T,...v];for(let k of C){let N="";try{k.programId?N=k.programId.toBase58?.()||String(k.programId):typeof k.programIdIndex=="number"&&(N=K[k.programIdIndex]?.toBase58?.()||"")}catch{}if(N!==Te)continue;let G=_(k.data);G&&(console.log("\u{1F9E9} Found memo:",G),G.includes("SANCTOS")&&(console.log("\u{1F4AC}",S.signature,G),m++))}}return console.log(`\u{1FAB6} Done. Found ${m} SANCTOS memos total.`),m}(()=>{let e=typeof window<"u"?window:globalThis;e.sanctos=e.sanctos||{},e.sanctos.debugScan=An,console.log("[SanctOS] \u{1FAB6} debugScan attached globally (robust)")})();function pt(e){return e.__sanctosMsgStore||=new Map,e.__sanctosMsgStore}function St(e,t){return`${e}->${t}`}(function(){let t=typeof window<"u"?window:globalThis;t.sanctos=t.sanctos||{},t.sanctos.getKnownSigs=function(n,a){let o=pt(t),c=St(n,a),l=o.get(c);return new Set(l?.ordered||[])},t.sanctos.getCachedMessages=function(n,a){let o=pt(t),c=St(n,a),l=o.get(c);return l?(l.ordered||[]).map(r=>l.bySig.get(r)).filter(Boolean):[]},t.sanctos.syncPair=async function(n,a={}){let c=(await t.sanctos.getAnchorProvider()).wallet.publicKey.toBase58(),l=pt(t),r=St(c,n),s=l.get(r)||{bySig:new Map,ordered:[],lastAt:0,lastSyncTs:0},i=new Set(s.ordered),u=await ht(n,{limit:a.limit,skipKnownSigs:i}),g=0,p=0,y=s.lastAt||0;for(let f of u){if(!f?.sig)continue;let w=s.bySig.get(f.sig);w?(w.text!==f.text||w.from!==f.from||w.at!==f.at||w.ok!==f.ok)&&(p++,s.bySig.set(f.sig,f)):(g++,s.bySig.set(f.sig,f),s.ordered.push(f.sig)),(f.at||0)>y&&(y=f.at||0)}return s.ordered.sort((f,w)=>(s.bySig.get(f)?.at||0)-(s.bySig.get(w)?.at||0)),s.lastAt=y,s.lastSyncTs=Date.now(),l.set(r,s),{added:g,updated:p,lastAt:y,messages:t.sanctos.getCachedMessages(c,n)}}})();async function jt(e,t,n=80){let a=typeof window<"u"?window:globalThis,o=a.solanaWeb3||a.web3||a.anchor&&a.anchor.web3;if(!o||!o.PublicKey)throw new Error("[SanctOS] PublicKey unavailable in discoverPeers");let{PublicKey:c}=o,l=t instanceof c?t:new c(t.toString()),r=e.connection,s=l.toBase58();function i(y){try{if(!y)return"";if(typeof y=="string"){if(y.startsWith("SANCTOS_"))return y;let f=a.bs58||typeof a.bs58mod<"u"&&a.bs58mod;if(f?.decode&&/^[1-9A-HJ-NP-Za-km-z]+$/.test(y)){let w=f.decode(y);return new TextDecoder().decode(w)}return""}return y instanceof Uint8Array?new TextDecoder().decode(y):Array.isArray(y)?new TextDecoder().decode(new Uint8Array(y)):y?.data&&Array.isArray(y.data)?new TextDecoder().decode(new Uint8Array(y.data)):""}catch{return""}}let u=new Set,g=await r.getSignaturesForAddress(l,{limit:n});for(let y of g){let f=await r.getTransaction(y.signature,{commitment:"confirmed",maxSupportedTransactionVersion:0});if(!f)continue;let w=f.transaction.message.staticAccountKeys||f.transaction.message.accountKeys||[],_=f.transaction.message.instructions||[],m=(f.meta?.innerInstructions||[]).flatMap(b=>b.instructions||[]),S=[..._,...m];for(let b of S){let K="";try{b.programId?K=b.programId.toBase58?.()||String(b.programId):typeof b.programIdIndex=="number"&&(K=w[b.programIdIndex]?.toBase58?.()||"")}catch{}if(K!==Te)continue;let T=i(b.data);if(!T||!T.startsWith("SANCTOS_MSG:"))continue;let v=T.split(":");if(v.length<3)continue;let C=String(v[1]||"");C&&C!==s&&u.add(C)}}let p=Array.from(u);return console.log("[SanctOS\u{1F4EC}] discoverPeers found peers:",p),p}(()=>{let e=typeof window<"u"?window:globalThis;e.sanctos=e.sanctos||{};function t(o,c){try{let l=[`sanctos:peerdev:${o}->${c}`,`sanctos:peerdev:${c}->${o}`,`sanctos:badSigs:${o}->${c}`,`sanctos:badSigs:${c}->${o}`,`sanctos:forceFullRescan:${o}->${c}`,`sanctos:forceFullRescan:${c}->${o}`,`sanctos:pubkey:announced:${o}->${c}`,`sanctos:pubkey:announced:${c}->${o}`];for(let r of l){try{sessionStorage.removeItem(r)}catch{}try{localStorage.removeItem(r)}catch{}}try{let r=Object.keys(localStorage);for(let s of r)s.startsWith("sanctos:peerdev:")&&(s.includes(o)||s.includes(c))&&localStorage.removeItem(s)}catch{}console.log("[SanctOS\u{1F9FC}] Cleared ALL caches for pair",{me58:o,peer58:c})}catch(l){console.warn("[SanctOS\u{1F9FC}] clearPeerDevCaches failed:",l)}}async function n(o){try{if(!o)throw new Error("Missing peer address");let c=await e.sanctos.getAnchorProvider?.();if(!c||!c.wallet?.publicKey)throw new Error("Provider/wallet not ready");let l=e.solanaWeb3||e.web3||e.anchor&&e.anchor.web3;if(!l||!l.PublicKey)throw new Error("solanaWeb3.PublicKey missing");let{PublicKey:r}=l,i=c.wallet.publicKey.toBase58(),u=new r(o);t(i,o);let g=`sanctos:forceFullRescan:${i}->${o}`,p=`sanctos:forceFullRescan:${o}->${i}`;if(sessionStorage.setItem(g,Date.now().toString()),sessionStorage.setItem(p,Date.now().toString()),console.log("[SanctOS\u{1F9FC}] Marked pair for full rescan:",{me58:i,peer58:o}),typeof e.sanctos.fetchMessages=="function"){console.log("[SanctOS\u{1F501}] Forcing immediate scan with imported device key\u2026");let y=await e.sanctos.fetchMessages(o,{maxSupportedTransactionVersion:0});console.log("[SanctOS\u{1F501}] Rescan complete. Messages:",y);try{let f=globalThis.__sanctosApplyRescan;typeof f=="function"&&f({me:i,peer:o,msgs:y})}catch(f){console.warn("[SanctOS] \u26A0\uFE0F __sanctosApplyRescan hook failed:",f)}return y}else console.warn("[SanctOS] fetchMessages not available on g.sanctos")}catch(c){throw console.error("[SanctOS\u274C] forceRescanAndRedecode failed:",c),c}}async function a(o){let c=await e.sanctos.getAnchorProvider?.();if(!c||!c.wallet?.publicKey)throw new Error("Provider/wallet not ready");let r=c.wallet.publicKey.toBase58();t(r,o),console.log("[SanctOS\u{1F91D}] Handshake state cleared for pair; next send/scan will republish device key:",{me:r,peer:o})}e.sanctos.forceRescanAndRedecode=n,e.sanctos.resetDeviceHandshakeForPeer=a,console.log("[SanctOS\u{1F9FC}] forceRescanAndRedecode + resetDeviceHandshakeForPeer attached")})();async function at(e,t,n){let a=new M.PublicKey(t),o=new M.PublicKey(n);console.log(`[SanctOS] \u{1F504} Manual repairPeerKey triggered: ${a.toBase58()} <-> ${o.toBase58()}`),await be(e,a,o),console.log("[SanctOS] \u{1FAAA} Re-published device pubkey"),await new Promise(r=>setTimeout(r,1500));let c=await le(e,a,o);c?(je(a,o,c),console.log("[SanctOS] \u{1F9E0} Peer device key found & cached (both directions)")):console.warn("[SanctOS] \u26A0\uFE0F Could not locate peer device key after repair");let l=`sanctos:lastRepair:${a.toBase58()}->${o.toBase58()}`;sessionStorage.setItem(l,Date.now().toString())}async function Ye(e,t,n){try{let a=`sanctos:lastRepair:${t.toBase58()}->${n.toBase58()}`,o=sessionStorage.getItem(a);if(o&&Date.now()-parseInt(o)<6e4){console.log("[SanctOS] \u23F3 Skipping autoRepairPeerKey (too soon)");return}console.log("[SanctOS] \u{1FA79} Running autoRepairPeerKey...");let c=await le(e,t,n);c?(je(t,n,c),console.log("[SanctOS] \u2705 Peer device key repaired + cached")):(console.warn("[SanctOS] \u26A0\uFE0F Peer device key still missing, re-publishing our own"),await be(e,t,n),await new Promise(l=>setTimeout(l,1500))),sessionStorage.setItem(a,Date.now().toString())}catch(a){console.error("[SanctOS] \u274C autoRepairPeerKey failed:",a)}}(()=>{let e=typeof window<"u"?window:globalThis;e.__sanctosRepair=e.__sanctosRepair||{},e.__sanctosRepair.autoRepairPeerKey=Ye,e.__sanctosRepair.repairPeerKey=at,console.log("[SanctOS] \u{1F9E0} Repair helpers persisted in __sanctosRepair")})(),globalThis.__force_repair_hooks__={autoRepairPeerKey:Ye,repairPeerKey:at};try{globalThis.__force_repair_hooks__}catch{}function Pn(e,t){return e.toBuffer().compare(t.toBuffer())<=0?[e,t]:[t,e]}async function Tn(e,t){let[n,a]=Pn(e,t);return W.findProgramAddress([Buffer.from("thread"),n.toBuffer(),a.toBuffer()],L)}async function On(e,t){return W.findProgramAddress([Buffer.from("delegate"),e.toBuffer(),t.toBuffer()],L)}setTimeout(()=>{try{let e=typeof window<"u"?window:globalThis;e.sanctos=e.sanctos||{},e.__sanctosRepair=e.__sanctosRepair||{};let t={initThread:Mt,initOrAttachThread:vt,readThread:bn,postPointer:sn,postMessage:Lt,fetchMessages:ht,getDeviceKeypair:R,encryptMessage:Dt,decryptMessage:dt,deriveSharedKey:Ue,publishDevicePubkeyIfNeeded:be,findPeerDevicePubkey:le,getAnchorProvider:V,threadPda:he,PROGRAM_ID:L,debugThread:mn,autoRepairPeerKey:Ye,repairPeerKey:at,discoverPeers:jt,setDelegate:ft,revokeDelegate:cn,ensureDelegateAuth:yt,initThreadDelegated:gt,postPointerDelegated:Ct,postSanctosMsgDelegated:Je,postMessageDelegated:Wt};Object.assign(e.sanctos,t),Object.assign(e.__sanctosRepair,{autoRepairPeerKey:Ye,repairPeerKey:at}),e.sanctos.publishDevicePubkeyIfNeeded=be,e.__sanctosRepair.publishDevicePubkeyIfNeeded=be,e.publishDevicePubkeyIfNeeded=be,e.getAnchorProvider=V,console.log("[SanctOS] \u{1F9E9} Hotfix attach complete:",{getAnchorProvider:typeof e.sanctos.getAnchorProvider,publishDevicePubkeyIfNeeded:typeof e.sanctos.publishDevicePubkeyIfNeeded,autoRepairPeerKey:typeof e.sanctos.autoRepairPeerKey,repairPeerKey:typeof e.sanctos.repairPeerKey})}catch(e){console.error("[SanctOS] \u274C Hotfix attach failed:",e)}},2e3),setTimeout(()=>{let e=typeof window<"u"?window:globalThis;if(!e.sanctos)return;let t=e.__sanctosRepair||{};!e.sanctos.repairPeerKey&&typeof t.repairPeerKey=="function"&&(e.sanctos.repairPeerKey=t.repairPeerKey),!e.sanctos.autoRepairPeerKey&&typeof t.autoRepairPeerKey=="function"&&(e.sanctos.autoRepairPeerKey=t.autoRepairPeerKey),console.log("[SanctOS] \u{1F553} Late attach verification:",{repairPeerKey:typeof e.sanctos.repairPeerKey,autoRepairPeerKey:typeof e.sanctos.autoRepairPeerKey})},1500),console.log("[SanctOS] \u2705 File parsed successfully"),(()=>{let e=window;e.sanctos=e.sanctos??{};let t={getAnchorProvider:V,postMessage:Lt,fetchMessages:ht,findPeerDevicePubkey:le,publishDevicePubkeyIfNeeded:be,deriveSharedKey:Ue,getDeviceKeypair:R,discoverPeers:jt,setDelegate:ft,initThreadDelegated:gt,postPointerDelegated:Ct,postSanctosMsgDelegated:Je,postMessageDelegated:Wt};for(let n in t)e.sanctos[n]=t[n];console.log("[SanctOS\u{1F525}] Immediate global API restored:",Object.keys(e.sanctos))})(),(()=>{let e=typeof window<"u"?window:globalThis;e.sanctos=e.sanctos||{},typeof e.sanctos.postSanctosMsg!="function"&&(e.sanctos.postSanctosMsg=(...t)=>e.sanctos.postMessage?.(...t),console.log("[SanctOS] \u{1FAB6} postSanctosMsg proxy attached"))})();async function kn(e,t=80){let n=typeof window<"u"?window:globalThis,a=n.solanaWeb3||n.web3||n.anchor&&n.anchor.web3;if(!a||!a.PublicKey)throw new Error("[SanctOS\u{1F9F5}] PublicKey unavailable in debugThreadScan");let{PublicKey:o}=a,c=await n.sanctos.getAnchorProvider(),l=c.wallet.publicKey,r=new o(e),s=c.connection,[i]=he(l,r);console.log("[SanctOS\u{1F9F5}] debugThreadScan \u2192 Thread PDA:",i.toBase58());function u(y){try{if(!y)return"";if(typeof y=="string"){if(y.startsWith("SANCTOS_"))return y;let f=n.bs58||n.bs58mod;return f?.decode&&/^[1-9A-HJ-NP-Za-km-z]+$/.test(y)?new TextDecoder().decode(f.decode(y)):""}return y instanceof Uint8Array?new TextDecoder().decode(y):Array.isArray(y)?new TextDecoder().decode(new Uint8Array(y)):y?.data?new TextDecoder().decode(new Uint8Array(y.data)):""}catch{return""}}let g=await s.getSignaturesForAddress(i,{limit:t});console.log(`[SanctOS\u{1F9F5}] Found ${g.length} thread-related transactions`);let p=[];for(let y of g){let f=await s.getTransaction(y.signature,{maxSupportedTransactionVersion:0});if(!f)continue;let w=f.transaction.message.accountKeys||f.transaction.message.staticAccountKeys||[],_=f.transaction.message.instructions||[],m=f.meta?.innerInstructions?.flatMap(b=>b.instructions)||[],S=[..._,...m];for(let b of S){let K="";try{b.programId?K=b.programId.toBase58():typeof b.programIdIndex=="number"&&(K=w[b.programIdIndex].toBase58())}catch{}if(K!=="MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr")continue;let T=u(b.data);T&&(console.log("\u{1F4AC} memo:",T,"sig:",y.signature),p.push({sig:y.signature,memo:T}))}}return console.log(`[SanctOS\u{1F9F5}] Done. ${p.length} memos found.`),p}(()=>{let e=typeof window<"u"?window:globalThis;e.sanctos=e.sanctos||{},e.sanctos.debugThreadScan=kn,console.log("[SanctOS\u{1F9F5}] debugThreadScan attached to window.sanctos")})()})();(()=>{let d=typeof window<"u"?window:globalThis;d.sanctos=d.sanctos||{},d.sanctos.__buildTag="2025-12-10-thread-delegate-v3",console.log("[SanctOS] Build tag:",d.sanctos.__buildTag)})();(()=>{let d=typeof window<"u"?window:globalThis;d.sanctos=d.sanctos||{};let M="sanctos.delegate.";function W(z){let H="";for(let L=0;L<z.length;L++)H+=String.fromCharCode(z[L]);return btoa(H)}function ee(z){let H=atob(z),L=new Uint8Array(H.length);for(let F=0;F<H.length;F++)L[F]=H.charCodeAt(F);return L}function q(z){try{if(typeof z=="string"&&z.length)return z;if(z&&typeof z.toBase58=="function")return z.toBase58();if(d.wallet?.address)return String(d.wallet.address);if(d.wallet?.publicKey&&typeof d.wallet.publicKey.toBase58=="function")return d.wallet.publicKey.toBase58();if(d.me&&typeof d.me.toBase58=="function")return d.me.toBase58();if(d.solana?.publicKey&&typeof d.solana.publicKey.toBase58=="function")return d.solana.publicKey.toBase58();if(d.solana?.publicKey)return String(d.solana.publicKey)}catch{}return""}function ne(z){if(!z||!d.solanaWeb3?.Keypair)return null;let H=M+z,L=localStorage.getItem(H);if(L)try{let x=ee(L);return d.solanaWeb3.Keypair.fromSecretKey(x)}catch{localStorage.removeItem(H)}let F=d.solanaWeb3.Keypair.generate();return localStorage.setItem(H,W(F.secretKey)),F}d.getSanctosDelegateKeypair=d.getSanctosDelegateKeypair||function(){let z=q(void 0);if(!z)return null;if(d.__sanctosDelegateKeypair&&d.__sanctosDelegateOwner===z)return d.__sanctosDelegateKeypair;let H=ne(z);return H?(d.__sanctosDelegateKeypair=H,d.__sanctosDelegateOwner=z,H):null},d.sanctosPreloadDelegateKeypair=d.sanctosPreloadDelegateKeypair||function(z){let H=q(z);if(!H)return null;let L=ne(H);return L?(d.__sanctosDelegateKeypair=L,d.__sanctosDelegateOwner=H,d.sanctosGetDelegate58=d.sanctosGetDelegate58||function(){try{let F=d.__sanctosDelegateKeypair;return F?.publicKey?.toBase58?F.publicKey.toBase58():""}catch{return""}},L):null};let ie=d.sanctos.fullLogin;if(typeof ie=="function"&&!ie.__sanctos_delegate_mem_fix_wrapped){let z=async function(H,...L){let F=await ie.call(this,H,...L);try{d.sanctosPreloadDelegateKeypair(H);let x=d.__sanctosDelegateKeypair?.publicKey?.toBase58?.();x&&console.log("[SanctOS Delegate] Preloaded delegate into memory:",x)}catch(x){console.warn("[SanctOS Delegate] preload failed (non-fatal):",x)}return F};z.__sanctos_delegate_mem_fix_wrapped=!0,d.sanctos.fullLogin=z,console.log("[SanctOS Delegate] fullLogin wrapped (delegate memory preload)")}})();(()=>{let d=typeof window<"u"?window:globalThis;d.sanctos=d.sanctos||{},typeof d.sanctos.fetchMessages!="function"&&typeof d.fetchMessages=="function"&&(d.sanctos.fetchMessages=d.fetchMessages),typeof d.sanctos.getAnchorProvider!="function"&&typeof d.getAnchorProvider=="function"&&(d.sanctos.getAnchorProvider=d.getAnchorProvider),typeof d.sanctos.discoverPeers!="function"&&typeof d.discoverPeers=="function"&&(d.sanctos.discoverPeers=d.discoverPeers),typeof d.sanctos.postSanctosMsg!="function"&&typeof d.postSanctosMsg=="function"&&(d.sanctos.postSanctosMsg=d.postSanctosMsg),typeof d.sanctos.postSanctosMsgDelegated!="function"&&typeof d.postSanctosMsgDelegated=="function"&&(d.sanctos.postSanctosMsgDelegated=d.postSanctosMsgDelegated)})();(()=>{let d=typeof window<"u"?window:globalThis;d.sanctos=d.sanctos||{},typeof d.sanctos.postSanctosMsg!="function"&&typeof d.sanctos.postMessage=="function"&&(d.sanctos.postSanctosMsg=(...M)=>d.sanctos.postMessage(...M))})();(()=>{let d=typeof window<"u"?window:globalThis;d.sanctos=d.sanctos||{};function M(){let h=new Map;return{on(A,I){return h.has(A)||h.set(A,new Set),h.get(A).add(I),()=>h.get(A)?.delete(I)},emit(A,I){let E=h.get(A);if(!(!E||!E.size))for(let B of E)try{B(I)}catch(R){console.warn("[SanctOS API] listener error:",R)}}}}let W=d.__sanctosApiEmitter||=M(),ee=d.__sanctosApiMsgStore||=new Map,q=d.__sanctosApiMsgSeen||=new Map,ne=d.__sanctosApiLastSync||=new Map;function ie(h){return String(h||"").trim()}function z(h){return String(h?.sig||h?.signature||h?.txid||h?.id||"")||""}function H(h,A,I="append"){let E=ie(h);if(!E)return;let B=ee.get(E)||[],R=q.get(E)||new Set;q.has(E)||q.set(E,R),I==="replace"&&(B.length=0,R.clear());for(let X of A||[]){if(!X)continue;let J=z(X);if(J){if(R.has(J))continue;R.add(J)}B.push(X)}ee.set(E,B)}function L(){try{let h={};for(let[A,I]of ee.entries()){let E=q.get(A),B=I?.at?.(-1)?.at;h[A]={count:I?.length||0,seen:E?.size||0,lastAt:B}}return h}catch{return{}}}async function F(h=12e3){let A=Date.now();for(;Date.now()-A<h;){let I=d.sanctos;if(I&&typeof I.getAnchorProvider=="function"&&typeof I.fetchMessages=="function")return!0;await new Promise(E=>setTimeout(E,50))}throw new Error("[SanctOS API] ready() timeout: core functions not attached")}function x(...h){for(let A of h)if(typeof A=="function")return A;return null}async function ae(){await F();let h=d.sanctos,A=x(h.getAnchorProvider,d.getAnchorProvider);if(!A)throw new Error("[SanctOS API] getAnchorProvider missing");return await A()}function te(h){try{return h?.wallet?.publicKey?.toBase58?.()||""}catch{return""}}function Qe(h){try{let A=d.deviceStoreKey;if(typeof A=="function"){let I=A(h);return!!(I&&localStorage.getItem(I))}}catch{}try{for(let A of Object.keys(localStorage))if(A.includes(h)&&A.toLowerCase().includes("device"))return!0}catch{}return!1}function ye(){try{return d.__sanctosDelegateKeypair?.publicKey?.toBase58?.()||""}catch{return""}}async function we(){let h=await ae(),A=te(h),I=ye(),E=A?Qe(A):!1,B=!!d.__sanctosDelegateEnabled||!!I&&d.__sanctosDelegateEnabled!==!1;return{wallet58:A,hasDeviceKey:E,delegateEnabled:B,delegate58:I}}async function et(h={}){let A=await ae();if(!te(A))throw new Error("[SanctOS API] ensureIdentity: wallet not ready");let E=x(d.sanctos.ensureDeviceIdentityOnConnect,d.ensureDeviceIdentityOnConnect);if(E)try{await E(A)}catch(R){W.emit("error",{kind:"ensureIdentity",error:R})}if(h.interactive){let R=x(d.sanctos.openIdentityGate,d.sanctos.showIdentityGate,d.openIdentityGate,d.showIdentityGate);if(R)try{await R()}catch(X){W.emit("error",{kind:"identityGate",error:X})}}let B=await we();return W.emit("identity",B),B}async function xe(){await F();let h=d.sanctos,A=x(h.exportIdentity,h.exportBundle,d.exportIdentity);if(!A)throw new Error("[SanctOS API] exportIdentity: not available in this build");return await A()}async function We(h){await F();let A=d.sanctos,I=x(A.importIdentity,A.importBundle,d.importIdentity);if(!I)throw new Error("[SanctOS API] importIdentity: not available in this build");let E=await I(h);try{let B=await we();W.emit("identity",B)}catch{}return E}async function Tt(h,A,I={}){await F();let E=d.sanctos,B=String(h||"").trim(),R=String(A??"");if(!B)throw new Error("[SanctOS API] send: peer58 missing");if(I?.delegate===!0){let Oe=x(E.postMessageDelegated,d.postMessageDelegated);if(!Oe)throw new Error("[SanctOS API] send(delegate): postMessageDelegated missing");return await Oe(B,R)}let X=x(E.postSanctosMsg,E.postMessage,d.postSanctosMsg);if(!X)throw new Error("[SanctOS API] send: no wallet send function found");let J=d.__sanctosDelegateKeypair,oe=d.__sanctosDelegateEnabled;try{try{d.__sanctosDelegateKeypair=null}catch{}try{d.__sanctosDelegateEnabled=!1}catch{}return await X(B,R,I)}finally{try{d.__sanctosDelegateKeypair=J}catch{}try{d.__sanctosDelegateEnabled=oe}catch{}}}async function he(h,A={}){return await F(),await d.sanctos.fetchMessages(h,{...A,onMessage:B=>{try{H(h,[B],"append")}catch{}try{typeof A.onMessage=="function"&&A.onMessage(B)}catch{}W.emit("message",{peer:h,msg:B})}})}(()=>{let h=typeof window<"u"?window:globalThis;h.sanctos=h.sanctos||{},typeof h.sanctos.fetchMessages!="function"&&typeof h.fetchMessages=="function"&&(h.sanctos.fetchMessages=h.fetchMessages),typeof h.sanctos.getAnchorProvider!="function"&&typeof h.getAnchorProvider=="function"&&(h.sanctos.getAnchorProvider=h.getAnchorProvider),typeof h.sanctos.discoverPeers!="function"&&typeof h.discoverPeers=="function"&&(h.sanctos.discoverPeers=h.discoverPeers),typeof h.sanctos.postSanctosMsg!="function"&&typeof h.postSanctosMsg=="function"&&(h.sanctos.postSanctosMsg=h.postSanctosMsg),typeof h.sanctos.postSanctosMsgDelegated!="function"&&typeof h.postSanctosMsgDelegated=="function"&&(h.sanctos.postSanctosMsgDelegated=h.postSanctosMsgDelegated)})();function Ot(h){let A=d.sanctos,I=x(A.getKnownSigs);if(!I)return new Set;try{let E=A.getAnchorProvider&&A.getAnchorProvider()||null,B=I(h);if(B instanceof Set)return B}catch{}try{let E=d.__sanctosLastMe58||"",B=I(E,h);if(B instanceof Set)return B}catch{}return new Set}function me(h){let A=ie(h),I=d.sanctos,E=x(I.getCachedMessages);if(E){try{let B=E(A);if(Array.isArray(B)&&B.length)return B}catch{}try{let B=d.__sanctosLastMe58||"",R=E(B,A);if(Array.isArray(R)&&R.length)return R}catch{}}try{let B=ee.get(A);if(Array.isArray(B)&&B.length)return B}catch{}try{let B=d.__sanctosLastMe58||d.wallet?.address||"";if(!B)return[];let X=((typeof d.loadConvoIndex=="function"?d.loadConvoIndex():null)||(()=>{try{let Se=localStorage.getItem(`sanctos.convoIndex.${B}`);return Se?JSON.parse(Se):[]}catch{return[]}})()||[]).find(Se=>Se&&(Se.peer===A||Se.peerAddr===A||Se.peerAddress===A)),J=String(X?.id||"");if(!J)return[];let oe=`sanctos.vault.${B}.convo.${J}`,Oe=localStorage.getItem(oe);if(!Oe)return[];let tt=JSON.parse(Oe)?.messages;return Array.isArray(tt)?tt:[]}catch{return[]}}async function pe(h,A={}){await F();let I=d.sanctos,E=await ae(),B=te(E);B&&(d.__sanctosLastMe58=B);let R=x(I.syncPair);if(R){let oe=await R(h,A);try{Array.isArray(oe?.messages)&&oe.messages.length&&H(h,oe.messages,"append"),ne.set(ie(h),oe)}catch{}return W.emit("messages",{peer:h,...oe}),oe}await he(h,{limit:A.limit});let X=me(h),J={peer:h,added:0,updated:0,lastAt:X.at?.(-1)?.at||0,messages:X};return ne.set(ie(h),J),W.emit("messages",J),J}d.__sanctosPeersCache||=new Map;async function fe(h={}){await F();let A=await ae(),I=te(A);if(!I)throw new Error("[SanctOS API] discoverPeers: wallet not ready");let E=Math.max(0,h.cacheMs??2e4),B=d.__sanctosPeersCache.get(I),R=Date.now();if(B&&R-B.ts<E)return B.peers;let X=x(d.sanctos.discoverPeers,d.discoverPeers);if(!X)throw new Error("[SanctOS API] discoverPeers: discoverPeers() not available");let J=[];try{J=await X(A,A.wallet.publicKey,h.limit??80)}catch{J=await X(h.limit??80)}let oe=Array.from(new Set((J||[]).filter(Boolean)));return d.__sanctosPeersCache.set(I,{ts:R,peers:oe}),W.emit("peers",{me:I,peers:oe}),oe}async function Re(h={}){let A=await ae(),I=te(A),E=d.__sanctosPeersCache.get(I);return E?.peers?.length?E.peers:await fe(h)}let Ee={async getStatus(){let h=await we(),A=d.__sanctosDelegateExpiresAt&&Number(d.__sanctosDelegateExpiresAt)||null,I=!!ye();return{enabled:h.delegateEnabled,delegate58:h.delegate58,hasKeypair:I,expiresAt:A}},async enable(h={}){await F();let A=d.sanctos,I=x(A.enableDelegate,A.setDelegateEnabled,d.enableDelegate);if(!I)throw new Error("[SanctOS API] delegate.enable: not implemented in this build");let E=await I(h);try{d.__sanctosDelegateEnabled=!0}catch{}return W.emit("delegate",await Ee.getStatus()),E},async disable(){await F();let h=d.sanctos,A=x(h.disableDelegate,h.setDelegateDisabled,d.disableDelegate);if(!A){try{d.__sanctosDelegateEnabled=!1}catch{}return W.emit("delegate",await Ee.getStatus()),{ok:!0,soft:!0}}let I=await A();try{d.__sanctosDelegateEnabled=!1}catch{}return W.emit("delegate",await Ee.getStatus()),I}},Ne=d.__sanctosApiPollers||=new Map;async function kt(h,A=250,I={}){await F(),Ge(h);let E=!1,B=String(h||"");if(!B)throw new Error("[SanctOS API] startPolling: missing peer58");let R=async()=>{for(;!E;){try{await he(h,I)}catch(J){W.emit("error",{kind:"poll",peer:h,error:J})}await new Promise(J=>setTimeout(J,Math.max(50,A|0)))}},X={stop:()=>E=!0};return Ne.set(B,X),R(),X}function Ge(h){let A=String(h||""),I=Ne.get(A);I?.stop&&I.stop(),Ne.delete(A)}async function V(){let h=await ae(),A=te(h),I=ye(),E=Number(d.__sanctosLastFetchMs||0)||0,B=d.__sanctosLastErr||null;return{me58:A,delegate58:I,rpc:h?.connection?._rpcEndpoint||h?.connection?.rpcEndpoint||null,lastFetchMs:E,lastError:B}}d.sanctos.api=d.sanctos.api||{},Object.assign(d.sanctos.api,{version:"0.2.0",ready:F,getMe:we,ensureIdentity:et,exportIdentity:xe,importIdentity:We,discoverPeers:fe,listPeers:Re,fetch:he,sync:pe,getMessages:me,getKnownSigs:Ot,send:Tt,delegate:Ee,on:W.on,startPolling:kt,stopPolling:Ge,health:V,__debugStore:L,getLastSync(h){try{return ne.get(ie(h))||null}catch{return null}},raw:d.sanctos}),console.log("[SanctOS API] \u2705 sanctos.api attached:",d.sanctos.api.version)})();})();
